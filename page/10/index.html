<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.1/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","images":"/images","scheme":"Gemini","version":"8.0.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}};
  </script>

  <meta name="description" content="学习还是需要记录">
<meta property="og:type" content="website">
<meta property="og:title" content="个人博客">
<meta property="og:url" content="http://example.com/page/10/index.html">
<meta property="og:site_name" content="个人博客">
<meta property="og:description" content="学习还是需要记录">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="灰(｢･ω･)｢嘿灰">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/page/10/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>个人博客</title>
  






  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">个人博客</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-schedule">

    <a href="/schedule/" rel="section"><i class="fa fa-calendar fa-fw"></i>Schedule</a>

  </li>
        <li class="menu-item menu-item-sitemap">

    <a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>Sitemap</a>

  </li>
        <li class="menu-item menu-item-commonweal">

    <a href="/404/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>Commonweal 404</a>

  </li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <section class="post-toc-wrap sidebar-panel">
        </section>
        <!--/noindex-->

        <section class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">灰(｢･ω･)｢嘿灰</p>
  <div class="site-description" itemprop="description">学习还是需要记录</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">158</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">30</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">91</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



        </section>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">
      

      
    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/12/22/%E4%B8%AD%E9%97%B4%E4%BB%B6%E4%B9%8BZookeeper%E4%B9%8B%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="灰(｢･ω･)｢嘿灰">
      <meta itemprop="description" content="学习还是需要记录">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="个人博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/12/22/%E4%B8%AD%E9%97%B4%E4%BB%B6%E4%B9%8BZookeeper%E4%B9%8B%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/" class="post-title-link" itemprop="url">Zookeeper之简单使用</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2020-12-22 11:00:42" itemprop="dateCreated datePublished" datetime="2020-12-22T11:00:42+08:00">2020-12-22</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2024-07-12 10:34:27" itemprop="dateModified" datetime="2024-07-12T10:34:27+08:00">2024-07-12</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Zookeeper/" itemprop="url" rel="index"><span itemprop="name">Zookeeper</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="一、初识-zookeeper"><a href="#一、初识-zookeeper" class="headerlink" title="一、初识 zookeeper"></a>一、初识 zookeeper</h2><p><code>Zookeeper</code> 它作为<code>Hadoop</code>项目中的一个开源子项目，是一个经典的分布式数据一致性解决方案，致力于为分布式应用提供一个高性能、高可用，且具有严格顺序访问控制能力的分布式协调服务。</p>
<h3 id="1、zookeeper数据模型"><a href="#1、zookeeper数据模型" class="headerlink" title="1、zookeeper数据模型"></a>1、zookeeper数据模型</h3><p><code>zookeeper</code> 维护了一个类似文件系统的数据结构，每个子目录（/微信、/微信/公众号）都被称作为 <code>znode</code> 即节点。和文件系统一样，我们可以很轻松的对 <code>znode</code> 节点进行增加、删除等操作，而且还可以在一个<code>znode</code>下增加、删除<code>子znode</code>，区别在于文件系统的是，<code>znode</code>可以存储数据（严格说是必须存放数据，默认是个空字符）。</p>
<p>由于<code>zookeeper</code>是目录节点结构，在获取和创建节点时，必须要以<code>“/”</code> 开头，否则在获取节点时会报错 <code>Path must start with / character</code>。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[zk: localhost:<span class="number">2181</span>(CONNECTED) <span class="number">13</span>] get test</span><br><span class="line">Command failed: java.lang.IllegalArgumentException: Path must start <span class="keyword">with</span> / character</span><br></pre></td></tr></table></figure>

<p>根节点名必须为<code>“/XXX”</code>，创建子节点时必须要带上根节点目录<code>“/XXX/CCC”</code>、<code>“/XXX/AAA”</code>。</p>
<p>例如：想要获取下图 <code>程序员内点事</code> 节点必须拼接完整的路径 <code>get /微信/公众号/程序员内点事</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">get /微信/公众号/程序员内点事</span><br></pre></td></tr></table></figure>
<p><img src="/2020/12/22/%E4%B8%AD%E9%97%B4%E4%BB%B6%E4%B9%8BZookeeper%E4%B9%8B%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/ee94371033334df0adaa31ccc7933ef4~tplv-k3u1fbpfcp-zoom-1.image" alt="在这里插入图片描述"></p>
<p><code>znode</code>被用来存储 <code>byte级</code> 或 <code>kb级</code> 的数据，可存储的最大数据量是<code>1MB</code>（<strong>请注意</strong>：一个节点的数据量不仅包含它自身存储数据，它的所有子节点的名字也要折算成Byte数计入，因此<code>znode</code>的子节点数也不是无限的）虽然可以手动的修改节点存储量大小，但一般情况下并不推荐这样做。</p>
<h3 id="2、znode节点属性"><a href="#2、znode节点属性" class="headerlink" title="2、znode节点属性"></a>2、znode节点属性</h3><p>一个<code>znode</code>节点不仅可以存储数据，还有一些其他特别的属性。接下来我们创建一个<code>/test</code>节点分析一下它各个属性的含义。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[zk: localhost:2181(CONNECTED) 6] get /<span class="built_in">test</span></span><br><span class="line">456</span><br><span class="line">cZxid = 0x59ac //</span><br><span class="line">ctime = Mon Mar 30 15:20:08 CST 2020</span><br><span class="line">mZxid = 0x59ad</span><br><span class="line">mtime = Mon Mar 30 15:22:25 CST 2020</span><br><span class="line">pZxid = 0x59ac</span><br><span class="line">cversion = 0</span><br><span class="line">dataVersion = 2</span><br><span class="line">aclVersion = 0</span><br><span class="line">ephemeralOwner = 0x0</span><br><span class="line">dataLength = 3</span><br><span class="line">numChildren = 0  </span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>节点属性</th>
<th>注解</th>
</tr>
</thead>
<tbody><tr>
<td>cZxid</td>
<td>该数据节点被创建时的事务Id</td>
</tr>
<tr>
<td>mZxid</td>
<td>该数据节点被修改时最新的事物Id</td>
</tr>
<tr>
<td>pZxid</td>
<td>当前节点的父级节点事务Id</td>
</tr>
<tr>
<td>ctime</td>
<td>该数据节点创建时间</td>
</tr>
<tr>
<td>mtime</td>
<td>该数据节点最后修改时间</td>
</tr>
<tr>
<td>dataVersion</td>
<td>当前节点版本号（每修改一次值+1递增）</td>
</tr>
<tr>
<td>cversion</td>
<td>子节点版本号（子节点修改次数，每修改一次值+1递增）</td>
</tr>
<tr>
<td>aclVersion</td>
<td>当前节点acl版本号（节点被修改acl权限，每修改一次值+1递增）</td>
</tr>
<tr>
<td>ephemeralOwner</td>
<td>临时节点标示，当前节点如果是临时节点，则存储的创建者的会话id（sessionId），如果不是，那么值=0</td>
</tr>
<tr>
<td>dataLength</td>
<td>当前节点所存储的数据长度</td>
</tr>
<tr>
<td>numChildren</td>
<td>当前节点下子节点的个数</td>
</tr>
</tbody></table>
<p>我们看到一个<code>znode</code>节点的属性比较多，但比较主要的属性还是<code>zxid</code>、<code>version</code>、<code>acl</code> 这三个。</p>
<hr>
<p><strong>Zxid：</strong></p>
<p><code>znode</code>节点状态改变会导致该节点收到一个<code>zxid</code>格式的时间戳，这个时间戳是全局有序的，znode节点的建立或者更新都会产生一个新的。如果<code>zxid1</code>的值 &lt; <code>zxid2</code>的值，那么说明<code>zxid2</code>发生的改变在<code>zxid1</code>之后。每个znode节点都有3个<code>zxid</code>属性，<code>cZxid</code>（节点创建时间）、<code>mZxid</code>（该节点修改时间，与子节点无关）、<code>pZxid</code>（该节点或者该节点的子节点的最后一次创建或者修改时间，孙子节点无关）。</p>
<p><code>zxid</code>属性主要应用于<code>zookeeper</code>的集群，这个后边介绍集群时详细说。</p>
<p><strong>Version：</strong></p>
<p><code>znode</code>属性中一共有三个版本号<code>dataversion</code>（数据版本号）、<code>cversion</code>（子节点版本号）、<code>aclversion</code>（节点所拥有的ACL权限版本号）。</p>
<p><code>znode</code>中的数据可以有多个版本，如果某一个节点下存有多个数据版本，那么查询这个节点数据就需要带上版本号。每当我们对<code>znode</code>节点数据修改后，该节点的<code>dataversion</code>版本号会递增。当客户端请求该<code>znode</code>节点时，会同时返回节点数据和版本号。另外当<code>dataversion</code>为 <code>-1</code>的时候可以忽略版本进行操作。对一个节点设置权限时<code>aclVersion</code>版本号会递增，下边会详细说ACL权限控制。</p>
<p>验证一下，我们修改<code>/test</code>节点的数据看看<code>dataVersion </code>有什么变化，发现<code>dataVersion </code>属性变成了 3，版本号递增了。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[zk: localhost:2181(CONNECTED) 10] <span class="built_in">set</span> /<span class="built_in">test</span> 8888</span><br><span class="line">cZxid = 0x59ac</span><br><span class="line">ctime = Mon Mar 30 15:20:08 CST 2020</span><br><span class="line">mZxid = 0x59b6</span><br><span class="line">mtime = Mon Mar 30 16:58:08 CST 2020</span><br><span class="line">pZxid = 0x59ac</span><br><span class="line">cversion = 0</span><br><span class="line">dataVersion = 3</span><br><span class="line">aclVersion = 0</span><br><span class="line">ephemeralOwner = 0x0</span><br><span class="line">dataLength = 4</span><br><span class="line">numChildren = 0</span><br></pre></td></tr></table></figure>

<h3 id="3、znode的类型"><a href="#3、znode的类型" class="headerlink" title="3、znode的类型"></a>3、znode的类型</h3><p><code>zookeeper</code> 有四种类型的<code>znode</code>，在用客户端 <code>client</code> 创建节点的时候需要指定类型。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zookeeper.create(<span class="string">&quot;/公众号/程序员内点事&quot;</span>, <span class="string">&quot;&quot;</span>.getBytes(), Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL_SEQUENTIAL);</span><br></pre></td></tr></table></figure>

<ul>
<li><code>PERSISTENT</code>-持久化目录节点 ：client创建节点后，与zookeeper断开连接该节点将被持久化，当client再次连接后节点依旧存在。</li>
<li><code>PERSISTENT_SEQUENTIAL</code>-持久化顺序节点 ：client创建节点后，与zookeeper断开连接该节点将被持久化，再次连接节点还存在，zookeeper会给该节点名称进行顺序编号，例如：/lock/0000000001、/lock/0000000002、/lock/0000000003。</li>
<li><code>EPHEMERAL</code>-临时目录节点 ： client与zookeeper断开连接后，该节点即会被删除</li>
<li><code>EPHEMERAL_SEQUENTIAL</code>-临时顺序节点 ： client与zookeeper断开连接后，该节点被删除，会给该节点名称进行顺序编号，例如：/lock/0000000001、/lock/0000000002、/lock/0000000003。</li>
</ul>
<h2 id="二、节点的ACL权限控制"><a href="#二、节点的ACL权限控制" class="headerlink" title="二、节点的ACL权限控制"></a>二、节点的ACL权限控制</h2><p><code>ACL</code>：即 <code>Access Control List</code> (节点的权限控制)，通过<code>ACL</code>机制来解决<code>znode</code>节点的访问权限问题，要注意的是<code>zookeeper</code>对权限的控制是基于<code>znode</code>级别的，也就说节点之间的权限不具有继承性，即子节点不继承父节点的权限。</p>
<p><code>zookeeper</code>中设置ACL权限的格式由<code>&lt;schema&gt;:&lt;id&gt;:&lt;acl&gt;</code>三段组成。</p>
<p><strong>schema</strong> ：表示授权的方式</p>
<ul>
<li><code>world</code>：表示任何人都可以访问</li>
<li><code>auth</code>：只有认证的用户可以访问</li>
<li><code>digest</code>：使用username  ：password用户密码生成MD5哈希值作为认证ID</li>
<li><code>host/ip</code>：使用客户端主机IP地址来进行认证</li>
</ul>
<p><strong>id</strong>： 权限的作用域，用来标识身份，依赖于schema选择哪种方式。</p>
<p><strong>acl</strong>：给一个节点赋予哪些权限，节点的权限有create,、delete、write、read、admin 统称 <code>cdwra</code>。</p>
<h3 id="1、world：表示任何人都可以访问"><a href="#1、world：表示任何人都可以访问" class="headerlink" title="1、world：表示任何人都可以访问"></a>1、<code>world</code>：表示任何人都可以访问</h3><p>我们用 <code>getAcl</code> 命令来看一下，没有设置过权限的<code>znode</code>节点，默认情况下的权限情况。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[zk: localhost:2181(CONNECTED) 12] getAcl /<span class="built_in">test</span></span><br><span class="line"><span class="string">&#x27;world,&#x27;</span>anyone</span><br><span class="line">: cdrwa</span><br></pre></td></tr></table></figure>

<p>看到没有设置ACL属性的节点，默认schema 使用的是<code>world</code>，作用域是<code>anyone</code>，节点权限是<code>cdwra</code>，也就是说任何人都可以访问。</p>
<p>那我们如果要给一个schema 为非<code>world</code>的节点设置<code>world</code>权限咋搞？</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setAcl /<span class="built_in">test</span> world:anyone:crdwa</span><br></pre></td></tr></table></figure>

<h3 id="2、auth：只有认证的用户可以访问"><a href="#2、auth：只有认证的用户可以访问" class="headerlink" title="2、auth：只有认证的用户可以访问"></a>2、<code>auth</code>：只有认证的用户可以访问</h3><p>schema 用<code>auth</code>授权表示只有认证后的用户才可以访问，那么首先就需要添加认证用户，添加完以后需要对认证的用户设置ACL权限。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">addauth digest <span class="built_in">test</span>:password(明文)</span><br></pre></td></tr></table></figure>

<p>需要注意的是设置认证用户时的密码是明文的。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[zk: localhost:2181(CONNECTED) 2] addauth digest user:user //用户名：密码</span><br><span class="line">[zk: localhost:2181(CONNECTED) 5] setAcl /<span class="built_in">test</span> auth:user:crdwa</span><br><span class="line">[zk: localhost:2181(CONNECTED) 6] getAcl /<span class="built_in">test</span></span><br><span class="line"><span class="string">&#x27;digest,&#x27;</span>user:ben+k/3JomjGj4mfd4fYsfM6p0A=</span><br><span class="line">: cdrwa</span><br></pre></td></tr></table></figure>

<p>实际上我们这样设置以后，就是将这个节点开放给所有认证的用户，<code>setAcl /test auth:user:crdwa</code> 相当于<code>setAcl /test auth::crdwa</code>。</p>
<h3 id="3、digest：用户名-密码的验证方式"><a href="#3、digest：用户名-密码的验证方式" class="headerlink" title="3、digest：用户名:密码的验证方式"></a>3、<code>digest</code>：用户名:密码的验证方式</h3><p>用户名:密码方式授权是针对单个特定用户，这种方式是不需要先添加认证用户的。</p>
<p>如果在代码中使用zookeeper客户端设置ACL，那么密码是明文的，但若是zk.cli等客户端操作就需要将密码进行<code>sha1</code>及<code>base64</code>处理。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">setAcl &lt;path&gt; digest:&lt;user&gt;:&lt;password(密文)&gt;:&lt;acl&gt;</span><br><span class="line"></span><br><span class="line">setAcl /<span class="built_in">test</span> digest:user:jalRr+knv/6L2uXdenC93dEDNuE=:crdwa</span><br></pre></td></tr></table></figure>

<p>那么密码如何加密嘞？有以下几种方式：</p>
<p>通过<code>shell</code>命令加密</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> -n &lt;user&gt;:&lt;password&gt; | openssl dgst -binary -sha1 | openssl base64</span><br></pre></td></tr></table></figure>

<p>使用<code>zookeeper</code>自带的类库<code>org.apache.zookeeper.server.auth.DigestAuthenticationProvider</code>生成</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">java -cp /zookeeper-3.4.13/zookeeper-3.4.13.jar:/zookeeper-3.4.13/lib/slf4j-api-1.7.25.jar \</span><br><span class="line">  org.apache.zookeeper.server.auth.DigestAuthenticationProvider \</span><br><span class="line">  root:root</span><br><span class="line">root:root-&gt;root:qiTlqPLK7XM2ht3HMn02qRpkKIE=</span><br></pre></td></tr></table></figure>

<h3 id="4、host-ip：使用客户端主机IP地址来进行认证"><a href="#4、host-ip：使用客户端主机IP地址来进行认证" class="headerlink" title="4、host/ip：使用客户端主机IP地址来进行认证"></a>4、<code>host/ip</code>：使用客户端主机IP地址来进行认证</h3><p>这种方式就比较好理解了，通过对特定的IP地址，也可以是一个IP段进行授权。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[zk: localhost:2181(CONNECTED) 3] setAcl /test0000000014 ip:127.0.0.1:crdwa</span><br><span class="line">cZxid = 0x59ac</span><br><span class="line">ctime = Mon Mar 30 15:20:08 CST 2020</span><br><span class="line">mZxid = 0x59b6</span><br><span class="line">mtime = Mon Mar 30 16:58:08 CST 2020</span><br><span class="line">pZxid = 0x59ac</span><br><span class="line">cversion = 0</span><br><span class="line">dataVersion = 3</span><br><span class="line">aclVersion = 3 // 这个版本一直在增加</span><br><span class="line">ephemeralOwner = 0x0</span><br><span class="line">dataLength = 4</span><br><span class="line">numChildren = 0</span><br></pre></td></tr></table></figure>

<h2 id="三、zookeeper的灵魂-watcher"><a href="#三、zookeeper的灵魂-watcher" class="headerlink" title="三、zookeeper的灵魂 watcher"></a>三、zookeeper的灵魂 watcher</h2><p>我们在开头就说过：<code>zookeeper</code>可以为<code>dubbo</code>提供服务的注册与发现，作为注册中心，但你有想过<code>zookeeper</code>为啥能够实现服务的注册与发现吗？这就不得不说一下<code>zookeeper</code>的灵魂 <code>Watcher</code>（监听者）。</p>
<h3 id="1、watcher是个啥？"><a href="#1、watcher是个啥？" class="headerlink" title="1、watcher是个啥？"></a>1、watcher是个啥？</h3><p><code>watcher</code> 是<code>zooKeeper</code>中一个非常核心功能 ，客户端<code>watcher</code> 可以监控节点的数据变化以及它子节点的变化，一旦这些状态发生变化，zooKeeper服务端就会通知所有在这个节点上设置过<code>watcher</code>的客户端 ，从而每个客户端都很快感知，它所监听的节点状态发生变化，而做出对应的逻辑处理。</p>
<p>简单的介绍了一下<code>watcher</code> ，那么我们来分析一下，<code>zookeeper</code>是如何实现服务的注册与发现。 <code>zookeeper</code>的服务注册与发现，主要应用的是<code>zookeeper</code>的<code>znode</code>节点数据模型和<code>watcher</code>机制，大致的流程如下：</p>
<p><img src="/2020/12/22/%E4%B8%AD%E9%97%B4%E4%BB%B6%E4%B9%8BZookeeper%E4%B9%8B%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/2a10d2a2b39a4cedbcd430dc2a2394a4~tplv-k3u1fbpfcp-zoom-1.image" alt="在这里插入图片描述"></p>
<ul>
<li><strong>服务注册：</strong> 服务提供者（<code>Provider</code>）启动时，会向<code>zookeeper服务端</code>注册服务信息，也就是创建一个节点，例如：用户注册服务<code>com.xxx.user.register</code>，并在节点上存储服务的相关数据（如服务提供者的ip地址、端口等）。</li>
<li><strong>服务发现：</strong> 服务消费者（<code>Consumer</code>）启动时，根据自身配置的依赖服务信息，向<code>zookeeper服务端</code>获取注册的服务信息并设置<code>watch监听</code>，获取到注册的服务信息之后，将服务提供者的信息缓存在本地，并进行服务的调用。</li>
<li><strong>服务通知：</strong> 一旦服务提供者因某种原因宕机不再提供服务之后，客户端与<code>zookeeper</code>服务端断开连接，<code>zookeeper</code>服务端上服务提供者对应服务节点会被删除（例如：用户注册服务<code>com.xxx.user.register</code>），随后<code>zookeeper</code>服务端会异步向所有消费用户注册服务<code>com.xxx.user.register</code>，且设置了<code>watch监听</code>的服务消费者发出节点被删除的通知，消费者根据收到的通知拉取最新服务列表，更新本地缓存的服务列表。</li>
</ul>
<p>上边的过程就是<code>zookeeper</code>可以实现服务注册与发现的大致原理。</p>
<h3 id="2、watcher类型"><a href="#2、watcher类型" class="headerlink" title="2、watcher类型"></a>2、watcher类型</h3><p><code>znode</code>节点可以设置两类<code>watch</code>，一种是<code>DataWatches</code>，基于znode节点的数据变更从而触发 <code>watch</code> 事件，触发条件<code>getData()</code>、<code>exists()</code>、<code>setData()</code>、 <code>create()</code>。</p>
<p>另一种是<code>Child Watches</code>，基于znode的孩子节点发生变更触发的watch事件，触发条件 <code>getChildren()</code>、 <code>create()</code>。</p>
<p>而在调用 <code>delete()</code> 方法删除znode时，则会同时触发<code>Data Watches</code>和<code>Child Watches</code>，如果被删除的节点还有父节点，则父节点会触发一个<code>Child Watches</code>。</p>
<h3 id="3、watcher特性"><a href="#3、watcher特性" class="headerlink" title="3、watcher特性"></a>3、watcher特性</h3><p><code>watch</code>对节点的监听事件是一次性的！客户端在指定的节点设置了监听<code>watch</code>，一旦该节点数据发生变更通知一次客户端后，客户端对该节点的监听事件就失效了。</p>
<p>如果还要继续监听这个节点，就需要我们在客户端的监听回调中，再次对节点的监听<code>watch</code>事件设置为<code>True</code>。否则客户端只能接收到一次该节点的变更通知。</p>
<h2 id="四、zookeeper能实现哪些功能"><a href="#四、zookeeper能实现哪些功能" class="headerlink" title="四、zookeeper能实现哪些功能"></a>四、zookeeper能实现哪些功能</h2><p>服务的注册与发现功能只是zookeeper的冰山一角，它还能实现诸如分布式锁、队列、配置中心等一系列功能，接下来我们只分析一下原理，具体的实现大家上网查一下资料还是比较全的。</p>
<h3 id="1、分布式锁"><a href="#1、分布式锁" class="headerlink" title="1、分布式锁"></a>1、分布式锁</h3><p><code>zookeeper</code>基于<code>watcher</code>机制和<code>znode</code>的有序节点，天生就是一个分布式锁的坯子。首先创建一个<code>/test/lock</code>父节点作为一把锁，尽量是持久节点（PERSISTENT类型），每个尝试获取这把锁的客户端，在<code>/test/lock</code>父节点下创建临时顺序子节点。</p>
<p>由于序号的递增性，我们规定序号最小的节点即获得锁。例如：客户端来获取锁，在<code>/test/lock</code>节点下创建节点为<code>/test/lock/seq-00000001</code>，它是最小的所以它优先拿到了锁，其它节点等待通知再次获取锁。<code>/test/lock/seq-00000001</code>执行完自己的逻辑后删除节点释放锁。</p>
<p><strong>那么节点<code>/test/lock/seq-00000002</code>想要获取锁等谁的通知呢？</strong></p>
<p>这里我们让<code>/test/lock/seq-00000002</code>节点监听<code>/test/lock/seq-00000001</code>节点，一旦<code>/test/lock/seq-00000001</code>节点删除，则通知<code>/test/lock/seq-00000002</code>节点，让它再次判断自己是不是最小的节点，是则拿到锁，不是继续等通知。</p>
<p>以此类推<code>/test/lock/seq-00000003</code>节点监听<code>/test/lock/seq-00000002</code>节点，总是让后一个节点监听前一个节点，不用让所有节点都监听最小的节点，避免设置不必要的监听，以免造成大量无效的通知，形成“羊群效应”。</p>
<p><code>zookeeper</code>分布式锁和<code>redis</code>分布式锁相比，因为大量的创建、删除节点性能上比较差，并不是很推荐。 <img src="/2020/12/22/%E4%B8%AD%E9%97%B4%E4%BB%B6%E4%B9%8BZookeeper%E4%B9%8B%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/7d20302015de4629acd6d633bf0f5253~tplv-k3u1fbpfcp-zoom-1.image" alt="在这里插入图片描述"></p>
<h3 id="2、分布式队列"><a href="#2、分布式队列" class="headerlink" title="2、分布式队列"></a>2、分布式队列</h3><p>zookeeper实现分布式队列也很简单，应用znode的有序节点天然的“先进先出”，后创建的节点总是最大的，出队总是拿序号最小的节点即可。</p>
<h3 id="3、配置管理"><a href="#3、配置管理" class="headerlink" title="3、配置管理"></a>3、配置管理</h3><p>现在有很多开源项目都在使用Zookeeper来维护配置，像消息队列Kafka中，就使用Zookeeper来维护broker的信息；dubbo中管理服务的配置信息。原理也是基于<code>watcher</code>机制，例如：创建一个<code>/config</code>节点存放一些配置，客户端监听这个节点，一点修改<code>/config</code>节点的配置信息，通知各个客户端数据变更重新拉取配置信息。</p>
<h3 id="4、命名服务"><a href="#4、命名服务" class="headerlink" title="4、命名服务"></a>4、命名服务</h3><p><code>zookeeper</code>的命名服务：也就是我们常说的服务注册与发现，主要是根据指定名字来获取资源或服务的地址，服务提供者等信息，利用其<code>znode</code>节点的特点和<code>watcher</code>机制，将其作为动态注册和获取服务信息的配置中心，统一管理服务名称和其对应的服务器列表信息，我们能够近乎实时地感知到后端服务器的状态(上线、下线、宕机)。</p>
<h3 id="5、集群选举"><a href="#5、集群选举" class="headerlink" title="5、集群选举"></a>5、集群选举</h3><h2 id="五、基本操作"><a href="#五、基本操作" class="headerlink" title="五、基本操作"></a>五、基本操作</h2><h3 id="创建节点"><a href="#创建节点" class="headerlink" title="创建节点"></a>创建节点</h3><ul>
<li>create /blog “blog” 创建普通节点</li>
<li>create -e /blog-temp “temp” 创建临时节点</li>
<li>create -s /blog-sequence “sequence” 创建序列节点</li>
<li>create -s  -e /blog-ts “ts” 创建带序号的临时节点</li>
</ul>
<h3 id="节点监听"><a href="#节点监听" class="headerlink" title="节点监听"></a>节点监听</h3><ul>
<li>get /servers watch   节点的值变化监听</li>
<li>ls /servers watch 节点的子节点变化监听（增、删）</li>
<li>stat -w /path 监听节点属性的变化</li>
</ul>
<h3 id="删除节点"><a href="#删除节点" class="headerlink" title="删除节点"></a>删除节点</h3><ul>
<li>delete /blog  删除节点（不能删除带有子节点的节点）</li>
<li>rmr /sanguo  递归删除节点（可以删除带有子节点的节点）</li>
</ul>
<h3 id="显示配额"><a href="#显示配额" class="headerlink" title="显示配额"></a>显示配额</h3><ul>
<li>listquota /zookeeper  返回值count=2,bytes=-1 节点个数限额为2，长度无限额</li>
</ul>
<h3 id="查看节点状态"><a href="#查看节点状态" class="headerlink" title="查看节点状态"></a>查看节点状态</h3><ul>
<li>stat /blog-temp</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cZxid &#x3D; 0x70000012e  引起这个znode创建的zxid，创建节点的事务的zxid（ZooKeeper Transaction Id），每次修改ZooKeeper状态都会收到一个zxid形式的时间戳，也就是ZooKeeper事务ID。事务ID是ZooKeeper中所有修改总的次序。每个修改都有唯一的zxid，如果zxid1小于zxid2，那么zxid1在zxid2之前发生</span><br><span class="line">ctime &#x3D; Mon Oct 12 06:08:52 UTC 2020 znode被创建的时间戳(从1970年开始)</span><br><span class="line">mZxid &#x3D; 0x70000012e znode最后更新的zxid</span><br><span class="line">mtime &#x3D; Mon Oct 12 06:08:52 UTC 2020 znode最后修改的时间戳(从1970年开始)</span><br><span class="line">pZxid &#x3D; 0x70000012e  znode最后更新的子节点zxid</span><br><span class="line">cversion &#x3D; 0 znode子节点变化号，znode子节点修改次数</span><br><span class="line">dataVersion &#x3D; 0 znode数据变化号</span><br><span class="line">aclVersion &#x3D; 0 znode访问控制列表的变化号</span><br><span class="line">ephemeralOwner &#x3D; 0x0 如果是临时节点，这个是znode拥有者的session id。如果不是临时节点则是0</span><br><span class="line">dataLength &#x3D; 4 znode的数据长度</span><br><span class="line">numChildren &#x3D; 0 znode子节点数量</span><br></pre></td></tr></table></figure>

<h2 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h2><ul>
<li>  分布式消息同步和协调机制</li>
<li>  服务器节点动态上下线</li>
<li>  统一配置管理</li>
<li>  负载均衡</li>
<li>  集群管理</li>
<li>  。。。。。。</li>
</ul>
<h2 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h2><p>  zookeeper的数据模型的结构和unix文件系统很相似，整体上看是一颗目录树，每一个节点称为ZNode（每个节点不但有目录名称，还必须要有值，类似于键值对）。<br>  zookeeper集群自身维护了一套数据结构。这个存储结构是一个树形结构，其上的每一个节点，我们称之为”znode”，每一个znode默认能够存储1MB的数据，每个ZNode都可以通过其路径唯一标识。</p>
<h2 id="节点类型"><a href="#节点类型" class="headerlink" title="节点类型"></a>节点类型</h2><ul>
<li>  短暂（ephemeral）：客户端和服务器端断开连接后，创建的节点自己删除。</li>
<li>  持久（persistent）：客户端和服务器端断开连接后，创建的节点不删除。</li>
<li>  持久化顺序编号目录节点（PERSISTENT_SEQUENTIAL）：客户端与zookeeper断开连接后，该节点依旧存在，只是Zookeeper给该节点名称进行顺序编号，顺序编号有小到大。</li>
<li>  临时顺序编号目录节点（EPHEMERAL_SEQUENTIAL）：客户端与zookeeper断开连接后，该节点被删除，只是Zookeeper给该节点名称进行顺序编号，顺序编号有小到大。</li>
</ul>
<h2 id="选举机制"><a href="#选举机制" class="headerlink" title="选举机制"></a>选举机制</h2><h2 id="zab原子广播协议"><a href="#zab原子广播协议" class="headerlink" title="zab原子广播协议"></a>zab原子广播协议</h2><h2 id="容错机制"><a href="#容错机制" class="headerlink" title="容错机制"></a>容错机制</h2><h2 id="失败恢复"><a href="#失败恢复" class="headerlink" title="失败恢复"></a>失败恢复</h2><h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6906694879380766727">zookeeper 基础</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_39381833/article/details/108145990">原子广播协议</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/12/22/java%E6%B3%9B%E5%9E%8B%E4%B9%8BType/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="灰(｢･ω･)｢嘿灰">
      <meta itemprop="description" content="学习还是需要记录">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="个人博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/12/22/java%E6%B3%9B%E5%9E%8B%E4%B9%8BType/" class="post-title-link" itemprop="url">java泛型之Type</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2020-12-22 10:19:02" itemprop="dateCreated datePublished" datetime="2020-12-22T10:19:02+08:00">2020-12-22</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2024-07-12 10:34:26" itemprop="dateModified" datetime="2024-07-12T10:34:26+08:00">2024-07-12</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/java%E5%9F%BA%E7%A1%80/" itemprop="url" rel="index"><span itemprop="name">java基础</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="Class（原始类型、基本数据类型-）"><a href="#Class（原始类型、基本数据类型-）" class="headerlink" title="Class（原始类型、基本数据类型 ）"></a>Class（原始类型、基本数据类型 ）</h2><p>Type的直接实现子类</p>
<h2 id="ParameterizedType（泛型参数化类型）"><a href="#ParameterizedType（泛型参数化类型）" class="headerlink" title="ParameterizedType（泛型参数化类型）"></a>ParameterizedType（泛型参数化类型）</h2><p>参数化的类型，比如Collection&lt;?&gt;,实现类是<strong>ParameterizedTypeImpl</strong></p>
<p>public Type[] getActualTypeArguments() ;   返回实际的Type()。</p>
<h2 id="GenericArrayType（泛型数组类型）"><a href="#GenericArrayType（泛型数组类型）" class="headerlink" title="GenericArrayType（泛型数组类型）"></a>GenericArrayType（泛型数组类型）</h2><p>元素类型是参数化类型或者类型变量的数组类型,实现类<strong>GenericArrayTypeImpl</strong></p>
<p>public Type getGenericComponentType()；获取泛型数组类型</p>
<h2 id="TypeVariable（泛型类型变量）"><a href="#TypeVariable（泛型类型变量）" class="headerlink" title="TypeVariable（泛型类型变量）"></a>TypeVariable（泛型类型变量）</h2><p>各种类型变量的公共父接口，实现类是<strong>TypeVariableImpl</strong></p>
<p>public D getGenericDeclaration()；</p>
<h2 id="WildcardType（泛型通配符类型）"><a href="#WildcardType（泛型通配符类型）" class="headerlink" title="WildcardType（泛型通配符类型）"></a>WildcardType（泛型通配符类型）</h2><p>一种通配符类型表达式，比如?, ? extends Number, ? super Integer，实现类：<strong>WildcardTypeImpl</strong></p>
<p>Type[] getUpperBounds();  获取通配符表达式对象的泛型限定的上边界的类型</p>
<p>Type[] getLowerBounds(); 下边界类型</p>
<h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> E <span class="title">methodIV</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">ArrayList&lt;ArrayList&gt; al1,  //al1的类型是ArrayList，返回类型是ParameterizedType</span></span></span><br><span class="line"><span class="function"><span class="params">ArrayList&lt;E&gt; al2,          //al2的类型是E，返回类型是TypeVariable</span></span></span><br><span class="line"><span class="function"><span class="params">ArrayList&lt;String&gt; al3,     //al3的类型是String，返回类型是Class</span></span></span><br><span class="line"><span class="function"><span class="params">ArrayList&lt;? extends Number&gt; al4,   //al4的类型是? extends Number，返回类型是WildcardType</span></span></span><br><span class="line"><span class="function"><span class="params">ArrayList&lt;E[]&gt; al5)</span></span>&#123;&#125;)     <span class="comment">//al5的类型是E[]，返回类型是GenericArrayType</span></span><br></pre></td></tr></table></figure>

<h2 id="泛型"><a href="#泛型" class="headerlink" title="泛型"></a>泛型</h2><h3 id="泛型出现之前的类型"><a href="#泛型出现之前的类型" class="headerlink" title="泛型出现之前的类型"></a>泛型出现之前的类型</h3><p>没有泛型的时候，只有所谓的原始类型。此时，所有的原始类型都通过字节码文件类Class类进行抽象。Class类的一个具体对象就代表一个指定的原始类型。</p>
<h3 id="泛型出现之后的类型"><a href="#泛型出现之后的类型" class="headerlink" title="泛型出现之后的类型"></a>泛型出现之后的类型</h3><p>泛型出现之后，扩充了数据类型。从只有原始类型扩充了参数化类型、类型变量类型、泛型限定的的参数化类型 (含通配符+通配符限定表达式)、泛型数组类型。</p>
<h3 id="与泛型有关的类型不能和原始类型统一到Class的原因"><a href="#与泛型有关的类型不能和原始类型统一到Class的原因" class="headerlink" title="与泛型有关的类型不能和原始类型统一到Class的原因"></a>与泛型有关的类型不能和原始类型统一到Class的原因</h3><p>[1]. 【产生泛型擦除的原因】<br>本来新产生的类型+原始类型都应该统一成各自的字节码文件类型对象。但是由于泛型不是最初Java中的成分。如果真的加入了泛型，涉及到JVM指令集的修改，这是非常致命的。<br>[2]. 【Java中如何引入泛型】<br>为了使用泛型的优势又不真正引入泛型，Java采用泛型擦除的机制来引入泛型。Java中的泛型仅仅是给编译器javac使用的，确保数据的安全性和免去强制类型转换的麻烦。但是，一旦编译完成，所有的和泛型有关的类型全部擦除。<br>[3]. 【Class不能表达与泛型有关的类型】<br>因此，与泛型有关的参数化类型、类型变量类型、泛型限定的的参数化类型 (含通配符+通配符限定表达式)、泛型数组类型这些类型全部被打回原形，在字节码文件中全部都是泛型被擦除后的原始类型，并不存在和自身类型一致的字节码文件。所以和泛型相关的新扩充进来的类型不能被统一到Class类中。<br>(4). 与泛型有关的类型在Java中的表示<br>为了通过反射操作这些类型以迎合实际开发的需要，Java就新增了ParameterizedType，GenericArrayType，TypeVariable 和WildcardType几种类型来代表不能被归一到Class类中的类型但是又和原始类型齐名的类型。<br>(5). Type的引入：统一与泛型有关的类型和原始类型Class</p>
<h3 id="引入Type的原因"><a href="#引入Type的原因" class="headerlink" title="引入Type的原因"></a>引入Type的原因</h3><p>为了程序的扩展性，最终引入了Type接口作为Class，ParameterizedType，GenericArrayType，TypeVariable和WildcardType这几种类型的总的父接口。这样实现了Type类型参数接受以上五种子类的实参或者返回值类型就是Type类型的参数。</p>
<h3 id="Type接口中没有方法的原因"><a href="#Type接口中没有方法的原因" class="headerlink" title="Type接口中没有方法的原因"></a>Type接口中没有方法的原因</h3><p>从上面看到，Type的出现仅仅起到了通过多态来达到程序扩展性提高的作用，没有其他的作用。因此Type接口的源码中没有任何方法。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/12/21/%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E%E4%BB%8B%E7%BB%8D/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="灰(｢･ω･)｢嘿灰">
      <meta itemprop="description" content="学习还是需要记录">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="个人博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/12/21/%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E%E4%BB%8B%E7%BB%8D/" class="post-title-link" itemprop="url">规则引擎介绍</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2020-12-21 18:19:02" itemprop="dateCreated datePublished" datetime="2020-12-21T18:19:02+08:00">2020-12-21</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2024-07-12 10:34:27" itemprop="dateModified" datetime="2024-07-12T10:34:27+08:00">2024-07-12</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E/" itemprop="url" rel="index"><span itemprop="name">规则引擎</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="Drools"><a href="#Drools" class="headerlink" title="Drools"></a>Drools</h2><p>Drools 是用 Java 语言编写的开放源码规则引擎，使用 Rete 算法对所编写的规则求值。Drools 允许使用声明方式表达业务逻辑。可以使用非 XML 的本地语言编写规则，从而便于学习和理解。并且，还可以将 Java 代码直接嵌入到规则文件中，这令 Drools 的学习更加吸引人。</p>
<p>Drools 还具有其他优点：</p>
<ul>
<li>非常活跃的社区支持</li>
<li>易用</li>
<li>快速的执行速度</li>
<li>在 Java 开发人员中流行</li>
<li>与 Java Rule Engine API（JSR 94）兼容</li>
</ul>
<h2 id="QLExpress"><a href="#QLExpress" class="headerlink" title="QLExpress"></a>QLExpress</h2><p>由阿里的电商业务规则、表达式（布尔组合）、特殊数学公式计算（高精度）、语法分析、脚本二次定制等强需求而设计的一门动态脚本引擎解析工具。 在阿里集团有很强的影响力，同时为了自身不断优化、发扬开源贡献精神，于2012年开源。</p>
<p>QLExpress脚本引擎被广泛应用在阿里的电商业务场景，具有以下的一些特性:</p>
<ul>
<li>1、线程安全，引擎运算过程中的产生的临时变量都是threadlocal类型。</li>
<li>2、高效执行，比较耗时的脚本编译过程可以缓存在本地机器，运行时的临时变量创建采用了缓冲池的技术，和groovy性能相当。</li>
<li>3、弱类型脚本语言，和groovy，javascript语法类似，虽然比强类型脚本语言要慢一些，但是使业务的灵活度大大增强。</li>
<li>4、安全控制,可以通过设置相关运行参数，预防死循环、高危系统api调用等情况。</li>
<li>5、代码精简，依赖最小，250k的jar包适合所有java的运行环境，在android系统的低端pos机也得到广泛运用。</li>
</ul>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a target="_blank" rel="noopener" href="https://gitee.com/cuibo119/QLExpress">QLExpress基本语法</a></p>
<p><a target="_blank" rel="noopener" href="https://developer.aliyun.com/article/621206">QLExpress功能清单</a></p>
<h2 id="Drools中文网"><a href="#Drools中文网" class="headerlink" title="Drools中文网"></a><a target="_blank" rel="noopener" href="http://www.drools.org.cn/">Drools中文网</a></h2>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/12/21/SQL%E7%9B%91%E6%8E%A7%E4%B9%8Bp6spy%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="灰(｢･ω･)｢嘿灰">
      <meta itemprop="description" content="学习还是需要记录">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="个人博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/12/21/SQL%E7%9B%91%E6%8E%A7%E4%B9%8Bp6spy%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/" class="post-title-link" itemprop="url">p6spy之简单使用</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2020-12-21 18:05:43" itemprop="dateCreated datePublished" datetime="2020-12-21T18:05:43+08:00">2020-12-21</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2024-07-12 10:34:26" itemprop="dateModified" datetime="2024-07-12T10:34:26+08:00">2024-07-12</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/p6spy/" itemprop="url" rel="index"><span itemprop="name">p6spy</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="p6spy作用"><a href="#p6spy作用" class="headerlink" title="p6spy作用"></a>p6spy作用</h2><p>将所有执行的sql打出日志，放在一个文件下。</p>
<p>p6spy将应用的数据源给劫持了，应用操作数据库其实在调用p6spy的数据源，p6spy劫持到需要执行的sql或者hql之类的语句之后，他自己去调用一个realDatasource，再去操作数据库</p>
<p>p6spy 可以输出日志到文件中、控制台、或者传递给 Log4j，而且还能配搭 SQL Profiler 或 IronTrackSQL 图形化监控 SQL 语句，监测到哪些语句的执行是耗时的，逐个优化。</p>
<h2 id="p6spy的配置"><a href="#p6spy的配置" class="headerlink" title="p6spy的配置"></a>p6spy的配置</h2><ul>
<li><p>p6spy.jar放入应用的classpath下</p>
</li>
<li><p>修改连接池或者连接配置的jdbc的驱动为p6spy所提供的驱动，com.p6spy.engine.spy.P6SpyDriver</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">在单独的Hibernate的应用中，数据库驱动配置在hibernate.cfg.xml里面,所以我需要配置文件中的connection.driver_class属性从oracle.jdbc.driver.OracleDriver改为com.p6spy.engine.spy.P6SpyDriver其他的用户名密码等等配置信息全部不用修改.在web程序中，配置的连接池部分，也只需要修改jdbc-driver的配置即可。</span><br><span class="line"><span class="tag">&lt;<span class="name">session-factory</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;connection.driver_class&quot;</span>&gt;</span>com.p6spy.engine.spy.P6SpyDriver<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;connection.url&quot;</span>&gt;</span>jdbc:oracle:thin:@localhost:1521:orcl<span class="tag">&lt;/<span class="name">property</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;connection.username&quot;</span>&gt;</span>scott<span class="tag">&lt;/<span class="name">property</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;connection.password&quot;</span>&gt;</span>tiger<span class="tag">&lt;/<span class="name">property</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;connection.pool_size&quot;</span>&gt;</span>1<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dialect&quot;</span>&gt;</span>org.hibernate.dialect.Oracle9Dialect<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;current_session_context_class&quot;</span>&gt;</span>thread<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;cache.provider_class&quot;</span>&gt;</span>org.hibernate.cache.NoCacheProvider<span class="tag">&lt;/<span class="name">property</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;show_sql&quot;</span>&gt;</span>true<span class="tag">&lt;/<span class="name">property</span>&gt;</span> <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;hbm2ddl.auto&quot;</span>&gt;</span>false<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;hibernate.jdbc.batch_size&quot;</span>&gt;</span>0<span class="tag">&lt;/<span class="name">property</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">session-factory</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>修改 spy.properties 并将其放到classpath下</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#################################################################</span></span><br><span class="line"><span class="comment"># MODULES                                                       #</span></span><br><span class="line"><span class="comment">#                                                               #</span></span><br><span class="line"><span class="comment"># Modules provide the P6Spy functionality.  If a module, such   #</span></span><br><span class="line"><span class="comment"># as module_log is commented out, that functionality will not   #</span></span><br><span class="line"><span class="comment"># be available.  If it is not commented out (if it is active),  #</span></span><br><span class="line"><span class="comment"># the functionality will be active.                             #</span></span><br><span class="line"><span class="comment">#                                                               #</span></span><br><span class="line"><span class="comment"># Values set in Modules cannot be reloaded using the            #</span></span><br><span class="line"><span class="comment"># reloadproperties variable.  Once they are loaded, they remain #</span></span><br><span class="line"><span class="comment"># in memory until the application is restarted.                 #</span></span><br><span class="line"><span class="comment">#                                                               #</span></span><br><span class="line"><span class="comment">#################################################################</span></span><br><span class="line"><span class="comment">#第一：module.log的属性必须配置，如果不配置，P6SPY将不起任何作用，典型配置：</span></span><br><span class="line"><span class="meta">module.log</span>=<span class="string">com.p6spy.engine.logging.P6LogFactory</span></span><br><span class="line"><span class="comment">#module.outage=com.p6spy.engine.outage.P6OutageFactory</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#################################################################</span></span><br><span class="line"><span class="comment"># REALDRIVER(s)                                                 #</span></span><br><span class="line"><span class="comment">#                                                               #</span></span><br><span class="line"><span class="comment"># In your application server configuration file you replace the #</span></span><br><span class="line"><span class="comment"># &quot;real driver&quot; name with com.p6spy.engine.P6SpyDriver. This is #</span></span><br><span class="line"><span class="comment"># where you put the name of your real driver P6Spy can find and #</span></span><br><span class="line"><span class="comment"># register your real driver to do the database work.            #</span></span><br><span class="line"><span class="comment">#                                                               #</span></span><br><span class="line"><span class="comment"># If your application uses several drivers specify them in      #</span></span><br><span class="line"><span class="comment"># realdriver2, realdriver3\.  See the documentation for more     #</span></span><br><span class="line"><span class="comment"># details.                                                      #</span></span><br><span class="line"><span class="comment">#                                                               #</span></span><br><span class="line"><span class="comment"># Values set in REALDRIVER(s) cannot be reloaded using the      #</span></span><br><span class="line"><span class="comment"># reloadproperties variable.  Once they are loaded, they remain #</span></span><br><span class="line"><span class="comment"># in memory until the application is restarted.                 #</span></span><br><span class="line"><span class="comment">#                                                               #</span></span><br><span class="line"><span class="comment">#################################################################</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#第二：数据库驱动配置，你懂的，不多说了</span></span><br><span class="line"><span class="comment"># oracle driver</span></span><br><span class="line"><span class="comment"># realdriver=oracle.jdbc.driver.OracleDriver</span></span><br><span class="line"><span class="comment"># mysql Connector/J driver</span></span><br><span class="line"><span class="comment"># realdriver=com.mysql.jdbc.Driver</span></span><br><span class="line"><span class="comment"># informix driver</span></span><br><span class="line"><span class="comment"># realdriver=com.informix.jdbc.IfxDriver</span></span><br><span class="line"><span class="comment"># ibm db2 driver</span></span><br><span class="line"><span class="comment"># realdriver=COM.ibm.db2.jdbc.net.DB2Driver</span></span><br><span class="line"><span class="comment"># the mysql open source driver</span></span><br><span class="line"><span class="attr">realdriver</span>=<span class="string">org.gjt.mm.mysql.Driver</span></span><br><span class="line"><span class="comment">#specifies another driver to use</span></span><br><span class="line"><span class="attr">realdriver2</span>=<span class="string"></span></span><br><span class="line"><span class="comment">#specifies a third driver to use</span></span><br><span class="line"><span class="attr">realdriver3</span>=<span class="string"></span></span><br><span class="line"></span><br><span class="line"><span class="comment">#第三：appender配置，一般分为三种</span></span><br><span class="line"><span class="comment">#specifies the appender to use for logging</span></span><br><span class="line"><span class="comment">#appender=com.p6spy.engine.logging.appender.Log4jLogger</span></span><br><span class="line"><span class="comment">#控制台</span></span><br><span class="line"><span class="comment">#appender=com.p6spy.engine.logging.appender.StdoutLogger</span></span><br><span class="line"><span class="attr">appender</span>=<span class="string">com.p6spy.engine.logging.appender.FileLogger</span></span><br><span class="line"><span class="comment"># name of logfile to use, note Windows users should make sure to use forward slashes in their pathname (e:/test/spy.log) (used for file logger only)</span></span><br><span class="line"><span class="comment">#日志文件存放路径及文件名</span></span><br><span class="line"><span class="attr">logfile</span>     = <span class="string">spy.log</span></span><br><span class="line"><span class="comment"># append to  the p6spy log file.  if this is set to false the</span></span><br><span class="line"><span class="comment"># log file is truncated every time.  (file logger only)</span></span><br><span class="line"><span class="attr">append</span>=<span class="string">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#The following are for log4j logging only</span></span><br><span class="line"><span class="meta">log4j.appender.STDOUT</span>=<span class="string">org.apache.log4j.ConsoleAppender</span></span><br><span class="line"><span class="meta">log4j.appender.STDOUT.layout</span>=<span class="string">org.apache.log4j.PatternLayout</span></span><br><span class="line"><span class="meta">log4j.appender.STDOUT.layout.ConversionPattern</span>=<span class="string">p6spy - %m%n</span></span><br><span class="line"></span><br><span class="line"><span class="meta">log4j.logger.p6spy</span>=<span class="string">INFO,STDOUT</span></span><br></pre></td></tr></table></figure>

</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/12/21/java%E4%B9%8B%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="灰(｢･ω･)｢嘿灰">
      <meta itemprop="description" content="学习还是需要记录">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="个人博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/12/21/java%E4%B9%8B%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/" class="post-title-link" itemprop="url">java之异常处理</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2020-12-21 17:53:17" itemprop="dateCreated datePublished" datetime="2020-12-21T17:53:17+08:00">2020-12-21</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2024-07-12 10:34:26" itemprop="dateModified" datetime="2024-07-12T10:34:26+08:00">2024-07-12</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/java%E5%9F%BA%E7%A1%80/" itemprop="url" rel="index"><span itemprop="name">java基础</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="异常分类"><a href="#异常分类" class="headerlink" title="异常分类"></a>异常分类</h2><ul>
<li><strong>检查性异常：</strong>最具代表的检查性异常是用户错误或问题引起的异常，这是程序员无法预见的。例如要打开一个不存在文件时，一个异常就发生了，这些异常在编译时不能被简单地忽略。</li>
<li><strong>运行时异常：</strong> 运行时异常是可能被程序员避免的异常。与检查性异常相反，运行时异常可以在编译时被忽略。</li>
<li><strong>错误：</strong> 错误不是异常，而是脱离程序员控制的问题。错误在代码中通常被忽略。例如，当栈溢出时，一个错误就发生了，它们在编译也检查不到的。</li>
</ul>
<h2 id="异常类图"><a href="#异常类图" class="headerlink" title="异常类图"></a>异常类图</h2><p><img src="/2020/12/21/java%E4%B9%8B%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/image-20201221175446673.png" alt="image-20201221175446673"></p>
<h2 id="Java-的非检查性异常"><a href="#Java-的非检查性异常" class="headerlink" title="Java 的非检查性异常"></a>Java 的非检查性异常</h2><table>
<thead>
<tr>
<th align="left"><strong>异常</strong></th>
<th align="left"><strong>描述</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left">ArithmeticException</td>
<td align="left">当出现异常的运算条件时，抛出此异常。例如，一个整数”除以零”时，抛出此类的一个实例。</td>
</tr>
<tr>
<td align="left">ArrayIndexOutOfBoundsException</td>
<td align="left">用非法索引访问数组时抛出的异常。如果索引为负或大于等于数组大小，则该索引为非法索引。</td>
</tr>
<tr>
<td align="left">ArrayStoreException</td>
<td align="left">试图将错误类型的对象存储到一个对象数组时抛出的异常。</td>
</tr>
<tr>
<td align="left">ClassCastException</td>
<td align="left">当试图将对象强制转换为不是实例的子类时，抛出该异常。</td>
</tr>
<tr>
<td align="left">IllegalArgumentException</td>
<td align="left">抛出的异常表明向方法传递了一个不合法或不正确的参数。</td>
</tr>
<tr>
<td align="left">IllegalMonitorStateException</td>
<td align="left">抛出的异常表明某一线程已经试图等待对象的监视器，或者试图通知其他正在等待对象的监视器而本身没有指定监视器的线程。</td>
</tr>
<tr>
<td align="left">IllegalStateException</td>
<td align="left">在非法或不适当的时间调用方法时产生的信号。换句话说，即 Java 环境或 Java 应用程序没有处于请求操作所要求的适当状态下。</td>
</tr>
<tr>
<td align="left">IllegalThreadStateException</td>
<td align="left">线程没有处于请求操作所要求的适当状态时抛出的异常。</td>
</tr>
<tr>
<td align="left">IndexOutOfBoundsException</td>
<td align="left">指示某排序索引（例如对数组、字符串或向量的排序）超出范围时抛出。</td>
</tr>
<tr>
<td align="left">NegativeArraySizeException</td>
<td align="left">如果应用程序试图创建大小为负的数组，则抛出该异常。</td>
</tr>
<tr>
<td align="left">NullPointerException</td>
<td align="left">当应用程序试图在需要对象的地方使用 <code>null</code> 时，抛出该异常</td>
</tr>
<tr>
<td align="left">NumberFormatException</td>
<td align="left">当应用程序试图将字符串转换成一种数值类型，但该字符串不能转换为适当格式时，抛出该异常。</td>
</tr>
<tr>
<td align="left">SecurityException</td>
<td align="left">由安全管理器抛出的异常，指示存在安全侵犯。</td>
</tr>
<tr>
<td align="left">StringIndexOutOfBoundsException</td>
<td align="left">此异常由 <code>String</code> 方法抛出，指示索引或者为负，或者超出字符串的大小。</td>
</tr>
<tr>
<td align="left">UnsupportedOperationException</td>
<td align="left">当不支持请求的操作时，抛出该异常。</td>
</tr>
</tbody></table>
<h2 id="检查性异常类"><a href="#检查性异常类" class="headerlink" title="检查性异常类"></a>检查性异常类</h2><table>
<thead>
<tr>
<th align="left"><strong>异常</strong></th>
<th align="left"><strong>描述</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left">ClassNotFoundException</td>
<td align="left">应用程序试图加载类时，找不到相应的类，抛出该异常。</td>
</tr>
<tr>
<td align="left">CloneNotSupportedException</td>
<td align="left">当调用 <code>Object</code> 类中的 <code>clone</code> 方法克隆对象，但该对象的类无法实现 <code>Cloneable</code> 接口时，抛出该异常。</td>
</tr>
<tr>
<td align="left">IllegalAccessException</td>
<td align="left">拒绝访问一个类的时候，抛出该异常。</td>
</tr>
<tr>
<td align="left">InstantiationException</td>
<td align="left">当试图使用 <code>Class</code> 类中的 <code>newInstance</code> 方法创建一个类的实例，而指定的类对象因为是一个接口或是一个抽象类而无法实例化时，抛出该异常。</td>
</tr>
<tr>
<td align="left">InterruptedException</td>
<td align="left">一个线程被另一个线程中断，抛出该异常。</td>
</tr>
<tr>
<td align="left">NoSuchFieldException</td>
<td align="left">请求的变量不存在</td>
</tr>
<tr>
<td align="left">NoSuchMethodException</td>
<td align="left">请求的方法不存在</td>
</tr>
</tbody></table>
<h2 id="异常方法"><a href="#异常方法" class="headerlink" title="异常方法"></a>异常方法</h2><table>
<thead>
<tr>
<th align="left"><strong>方法</strong></th>
<th align="left"><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left"><strong>public String getMessage()</strong></td>
<td align="left">返回关于发生的异常的详细信息。这个消息在Throwable 类的构造函数中初始化了。</td>
</tr>
<tr>
<td align="left"><strong>public Throwable getCause()</strong></td>
<td align="left">返回一个Throwable 对象代表异常原因。</td>
</tr>
<tr>
<td align="left"><strong>public String toString()</strong></td>
<td align="left">使用getMessage()的结果返回类的串级名字。</td>
</tr>
<tr>
<td align="left"><strong>public void printStackTrace()</strong></td>
<td align="left">打印toString()结果和栈层次到System.err，即错误输出流。</td>
</tr>
<tr>
<td align="left"><strong>public StackTraceElement [] getStackTrace()</strong></td>
<td align="left">返回一个包含堆栈层次的数组。下标为0的元素代表栈顶，最后一个元素代表方法调用堆栈的栈底。</td>
</tr>
<tr>
<td align="left"><strong>public Throwable fillInStackTrace()</strong></td>
<td align="left">用当前的调用栈层次填充Throwable 对象栈层次，添加到栈层次任何先前信息中。</td>
</tr>
</tbody></table>
<h2 id><a href="#" class="headerlink" title></a></h2>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/12/21/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B9%8Bnacos%E4%B9%8BgRPC%E8%B0%83%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="灰(｢･ω･)｢嘿灰">
      <meta itemprop="description" content="学习还是需要记录">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="个人博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/12/21/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B9%8Bnacos%E4%B9%8BgRPC%E8%B0%83%E7%94%A8/" class="post-title-link" itemprop="url">nacos之gRPC调用</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2020-12-21 17:32:39" itemprop="dateCreated datePublished" datetime="2020-12-21T17:32:39+08:00">2020-12-21</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2024-07-12 10:34:27" itemprop="dateModified" datetime="2024-07-12T10:34:27+08:00">2024-07-12</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" itemprop="url" rel="index"><span itemprop="name">微服务</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>acos 规划准备基于 gRPC 来替换现有的通信场景(Http + UDP)，以下是重点需要和社区讨论的项。请大家积极踊跃发表自己的看法。</p>
<h2 id="Nacos-能够替换成长连接的两大前提"><a href="#Nacos-能够替换成长连接的两大前提" class="headerlink" title="Nacos 能够替换成长连接的两大前提"></a>Nacos 能够替换成长连接的两大前提</h2><ul>
<li><p>通信模型的匹配</p>
<table>
<thead>
<tr>
<th align="center">现有的通信场景</th>
<th align="center">新的通讯场景</th>
</tr>
</thead>
<tbody><tr>
<td align="center">Http 服务接口 服务接口 Request/Response</td>
<td align="center">gRPC Request/Response</td>
</tr>
<tr>
<td align="center">配置推送 Http Long Polling</td>
<td align="center">gRPC Request/Stream</td>
</tr>
<tr>
<td align="center">UDP 服务推送 Request/Response</td>
<td align="center">gRPC Request/Stream</td>
</tr>
<tr>
<td align="center">支持ssl 通讯</td>
<td align="center">支持ssl 通讯</td>
</tr>
</tbody></table>
</li>
<li><p>通信的数据格式能够匹配</p>
<p>基于 gRPC 的业务层俩进程之间是需要协调好一致的通信数据格式 ，然后在 proto 文件里面来描述。为了能够服务好多场景下的通信模型数据格式的一致性，就像 Http 的通信数据格式一样，不 care 上层业务通信的数据具体表现形式，只 care 通信时数据格式的表现能力。以下关注两方面来阐述基于 gRPC 之后的数据格式长啥样。</p>
<ol>
<li><p>Request 数据格式</p>
<table>
<thead>
<tr>
<th align="center">通信数据格式字段</th>
<th align="center">数据类型</th>
<th align="center">必要性</th>
<th align="center">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">RequestId</td>
<td align="center">string</td>
<td align="center">必要</td>
<td align="center">标识当前的一次请求，方便于后续问题的排查</td>
</tr>
<tr>
<td align="center">Action</td>
<td align="center">string</td>
<td align="center">必要</td>
<td align="center">标识当前请求的具体行为，<strong>对标 Http 中的 URI 。</strong></td>
</tr>
<tr>
<td align="center">Headers</td>
<td align="center">map&lt;string,string&gt;</td>
<td align="center">必要</td>
<td align="center">动态可伸缩的消息头，<strong>对标 http 请求中的 header 。</strong></td>
</tr>
<tr>
<td align="center">Source</td>
<td align="center">string</td>
<td align="center">可选</td>
<td align="center">标明消息的发送源，是哪一个节点发送的消息。</td>
</tr>
<tr>
<td align="center">Params</td>
<td align="center">map&lt;string,string&gt; l 可选</td>
<td align="center">动态可伸缩的参数传递，<strong>对标 http 请求中的 参数传递。</strong></td>
<td align="center"></td>
</tr>
<tr>
<td align="center">Method</td>
<td align="center">string</td>
<td align="center">可选</td>
<td align="center">请求的 Method，<strong>对标 http 请求中的 method。</strong></td>
</tr>
<tr>
<td align="center">Payload</td>
<td align="center">byte[]</td>
<td align="center">必要</td>
<td align="center">请求的消息内容体，<strong>对标 http 请求中的 请求内容体。</strong></td>
</tr>
</tbody></table>
</li>
<li><p>Response 数据格式</p>
<table>
<thead>
<tr>
<th align="center">通信数据格式字段</th>
<th align="center">数据类型</th>
<th align="center">必要性</th>
<th align="center">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">ReponseId</td>
<td align="center">string</td>
<td align="center">必要</td>
<td align="center">标识当前的一次 response，方便于后续问题的排查 。通常他的值是来源于 request id，标识当前这个 response 是针对那次 请求进行响应的。</td>
</tr>
<tr>
<td align="center">Source</td>
<td align="center">string</td>
<td align="center">可选</td>
<td align="center">标明消息的Response源，是哪一个节点响应的消息。</td>
</tr>
<tr>
<td align="center">Action</td>
<td align="center">string</td>
<td align="center">必要</td>
<td align="center">标识当前 Response 是对哪个 Action 进行响应的。</td>
</tr>
<tr>
<td align="center">Headers</td>
<td align="center">map&lt;string,string&gt;</td>
<td align="center">必要</td>
<td align="center">动态可伸缩的消息头，<strong>对标 http 请求中的 header 。</strong></td>
</tr>
<tr>
<td align="center">Response Code</td>
<td align="center">int l 必要</td>
<td align="center">响应状态码，对标 http 响应中的响应码 。</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">Response Payload</td>
<td align="center">byte[]</td>
<td align="center">必要</td>
<td align="center">响应的消息内容体，<strong>对标 http 响应中的内容体。</strong></td>
</tr>
</tbody></table>
</li>
</ol>
</li>
</ul>
<h2 id="协议协商-通信的基础"><a href="#协议协商-通信的基础" class="headerlink" title="协议协商-通信的基础"></a>协议协商-通信的基础</h2><p>长连接支持的过程中必然会出现客户端/服务端，服务端/服务端 版本支持的通信协议不一致的情况。比如说，此时客户端支持 Http，但是服务端升级到新版本，既支持 Http,有支持 gRPC。这个时候客户端服务端通信要协商好一致的通信协议。面对客户端/服务端通信协议不一致的场景，主要采取<strong>通信协议降级</strong>的处理方式。通信协议降级处理主要分为两种：<strong>服务端通信协议降级处理</strong> 和 <strong>客户端通信协议降级处理</strong>。</p>
<ul>
<li><p>场景一：服务端版本高(既支持 Http+ UDP,有支持 gRPC),客户端版本低(支持 Http + UDP)。那这个时候经过客户端和服务端协议协商后，达成一致的通信协议是 Http + UDP。那么此时服务端对此客户端支持的通信协议就采用 Http +UDP，相对于新的通信协议，就降级了，这就是<strong>服务端通信协议降级处理。</strong></p>
<p><strong>注意:</strong> 服务端的通信协议降级处理是针对多个客户端而言的。因为有的客户端连接过来的是新版本，这个时候就没有服务端的通信协议降级处理，直接采用新的通信协议 gRPC 来处理；但是有的客户端连接过来的是低版本，那么这个时候就需要单独对这个客户端进行服务端通信协议降级处理了。</p>
</li>
<li><p>场景二：客户端版本高了(既支持 Http+ UDP,有支持 gRPC),服务端版本低(支持 Http + UDP)。那这个时候经过客户端和服务端协议协商后，达成一致的通信协议是 Http + UDP。那么此时客户端通信协议就采用 Http +UDP，相对于新的通信协议，就降级了，这就是<strong>客户端通信协议降级处理。</strong></p>
</li>
</ul>
<h2 id="服务端推送-Naming-Config-的支持"><a href="#服务端推送-Naming-Config-的支持" class="headerlink" title="服务端推送(Naming+Config)的支持"></a>服务端推送(Naming+Config)的支持</h2><ul>
<li>服务端推送-Naming(注册中心)</li>
<li>服务端推送-Config(配置中心)</li>
</ul>
<h2 id="Http-接口的改造"><a href="#Http-接口的改造" class="headerlink" title="Http 接口的改造"></a>Http 接口的改造</h2><p>Http 接口的改造，主要内容含两部分，分别是请求接口的数据和响应内容的处理。</p>
<ul>
<li><p>Http/gRPC 请求 通信数据格式的映射</p>
<table>
<thead>
<tr>
<th align="center">Http 请求</th>
<th align="center">gRPC 请求</th>
</tr>
</thead>
<tbody><tr>
<td align="center">URL</td>
<td align="center">Action</td>
</tr>
<tr>
<td align="center">Headers</td>
<td align="center">Headers</td>
</tr>
<tr>
<td align="center">Params</td>
<td align="center">Params</td>
</tr>
<tr>
<td align="center">Body</td>
<td align="center">Payload</td>
</tr>
<tr>
<td align="center">/</td>
<td align="center">其他字段按需指定</td>
</tr>
</tbody></table>
</li>
<li><p>Http/gRPC 响应 通信数据格式的映射</p>
<table>
<thead>
<tr>
<th align="center">Http 响应</th>
<th align="center">gRPC 响应</th>
</tr>
</thead>
<tbody><tr>
<td align="center">Response Code</td>
<td align="center">Response Code</td>
</tr>
<tr>
<td align="center">Response Body</td>
<td align="center">Response Payload</td>
</tr>
<tr>
<td align="center">Response Headers</td>
<td align="center">Response Headers</td>
</tr>
<tr>
<td align="center">/</td>
<td align="center">其他字段按需指定</td>
</tr>
</tbody></table>
<p>也就是说改为 gRPC 长连接之后，原先设置 Http 请求/响应所携带的相关数据都有具体的协议格式来于此对应，与此同时，在此基础上还丰富了原有的通信协议(例如 RequestId，Source 等)。在不失扩展性的同时，还降低了切换时数据通信改造和学习的成本。</p>
</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/12/21/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B9%8Bnacos%E4%B9%8B%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="灰(｢･ω･)｢嘿灰">
      <meta itemprop="description" content="学习还是需要记录">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="个人博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/12/21/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B9%8Bnacos%E4%B9%8B%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/" class="post-title-link" itemprop="url">nacos之注册中心原理解析</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2020-12-21 16:08:19" itemprop="dateCreated datePublished" datetime="2020-12-21T16:08:19+08:00">2020-12-21</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2024-07-12 10:34:27" itemprop="dateModified" datetime="2024-07-12T10:34:27+08:00">2024-07-12</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" itemprop="url" rel="index"><span itemprop="name">微服务</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><ul>
<li>注册和撤销服务，使用NamingProxy进行Http调用，使用jdk自带的Http协议API</li>
<li>查询服务，使用HostReactor类借助NamingProxy进行服务查询，重点是使用PushReceiver类创建UDP长连接，更新服务</li>
<li>subscribe/unsubscribe,使用EventDispatcher类addListener方法添加监听，重点是使用PushReceiver类创建UDP长连接，更新服务</li>
<li>都是使用定时任务线程池ScheduledExecutorService进行多线程处理</li>
</ul>
<h2 id="简单使用"><a href="#简单使用" class="headerlink" title="简单使用"></a>简单使用</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">properties.setProperty(<span class="string">&quot;serverAddr&quot;</span>, System.getProperty(<span class="string">&quot;serverAddr&quot;</span>));</span><br><span class="line">properties.setProperty(<span class="string">&quot;namespace&quot;</span>, System.getProperty(<span class="string">&quot;namespace&quot;</span>));</span><br><span class="line"></span><br><span class="line">NamingService naming = NamingFactory.createNamingService(properties);</span><br><span class="line"></span><br><span class="line">naming.registerInstance(<span class="string">&quot;nacos.test.3&quot;</span>, <span class="string">&quot;11.11.11.11&quot;</span>, <span class="number">8888</span>, <span class="string">&quot;TEST1&quot;</span>);</span><br><span class="line">naming.registerInstance(<span class="string">&quot;nacos.test.3&quot;</span>, <span class="string">&quot;2.2.2.2&quot;</span>, <span class="number">9999</span>, <span class="string">&quot;DEFAULT&quot;</span>);</span><br><span class="line">System.out.println(naming.getAllInstances(<span class="string">&quot;nacos.test.3&quot;</span>));</span><br><span class="line">naming.deregisterInstance(<span class="string">&quot;nacos.test.3&quot;</span>, <span class="string">&quot;2.2.2.2&quot;</span>, <span class="number">9999</span>, <span class="string">&quot;DEFAULT&quot;</span>);</span><br><span class="line">System.out.println(naming.getAllInstances(<span class="string">&quot;nacos.test.3&quot;</span>));</span><br><span class="line"></span><br><span class="line">naming.subscribe(<span class="string">&quot;nacos.test.3&quot;</span>, <span class="keyword">new</span> EventListener() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onEvent</span><span class="params">(Event event)</span> </span>&#123;</span><br><span class="line">        System.out.println(((NamingEvent)event).getServiceName());</span><br><span class="line">        System.out.println(((NamingEvent)event).getInstances());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="NamingService"><a href="#NamingService" class="headerlink" title="NamingService"></a>NamingService</h2><p>NamingService是Nacos对外提供给使用者的接口，其实现类为com.alibaba.nacos.client.naming.NacosNamingService，归纳起来，NamingService提供了以下方法：</p>
<ul>
<li>registerInstance：注册实例。</li>
<li>deregisterInstance：注销实例。</li>
<li>getAllInstances：获取某一服务的所有实例。</li>
<li>selectInstances：获取某一服务健康或不健康的实例。</li>
<li>selectOneHealthyInstance：根据权重选择一个健康的实例。</li>
<li>getServerStatus：检测服务端健康状态。</li>
<li>subscribe：注册对某个服务的监听。</li>
<li>unsubscribe：注销对某个服务的监听。</li>
<li>getSubscribeServices：获取被监听的服务。</li>
<li>getServicesOfServer：获取命名空间（namespace)下的所有服务名。</li>
</ul>
<h2 id="核心类"><a href="#核心类" class="headerlink" title="核心类"></a>核心类</h2><img src="/2020/12/21/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B9%8Bnacos%E4%B9%8B%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/baa968b2dce6422703ca528e5550ca19" alt="core-class" style="zoom: 50%;">

<h2 id="NacosNamingService"><a href="#NacosNamingService" class="headerlink" title="NacosNamingService"></a>NacosNamingService</h2><p>NacosNamingService是NamingService接口的实现类。实现了上面提到的那些方法。此外，NacosNamingService还起到了初始化其他核心类的作用，因为对外提供的方法都是委托给其他核心类处理的。按顺序将依次初始化EventDispatcher、NamingProxy、BeatReactor、HostReactor。从NacosNamingService的构造函数我们也可以了解到，可以进行一些参数的自定义，可参考<a target="_blank" rel="noopener" href="https://nacos.io/zh-cn/docs/concepts.html">官方文档</a></p>
<h2 id="EventDispatcher"><a href="#EventDispatcher" class="headerlink" title="EventDispatcher"></a>EventDispatcher</h2><p>EventDispatcher与其他事件分发的组件没什么不同，用于处理subscribe、unsubscribe等等与服务监听相关的方法，并分发NamingEvent到各Listener。成员变量ConcurrentMap&lt;String, List<EventListener>&gt; observerMap保存了注册的Listener，key为{服务名}@@{集群名}，value为各个EventListener的列表。EventDispatcher会启动<strong>1</strong>个名为com.alibaba.nacos.naming.client.listener的线程用于处理事件的分发。</EventListener></p>
<blockquote>
<p>注意点：</p>
<ul>
<li>分发NamingEvent时，按照subscribe(…)方法的调用顺序串行依次调用EventListener的onEvent(…)方法。</li>
<li>调用subscribe(…)方法会引起对应Service的事件分发。</li>
</ul>
</blockquote>
<h2 id="NamingProxy"><a href="#NamingProxy" class="headerlink" title="NamingProxy"></a>NamingProxy</h2><p>NamingProxy用于<strong>与Nacos服务端通信</strong>，注册服务、注销服务、发送心跳等都经由NamingProxy来请求服务端。NamingProxy会启动<strong>1</strong>个名为com.alibaba.nacos.client.naming.serverlist.updater的线程，用于定期调用refreshSrvIfNeed()方法更新Nacos服务端地址，默认间隔为<strong>30秒</strong>，对服务端API的调用将在后文总结。</p>
<blockquote>
<p>注意点：refreshSrvIfNeed()方法对Nacos服务端地址的更新仅在使用endpoint的时候才会进行实际更新，如果是通过serverAddr配置的Nacos服务端地址，refreshSrvIfNeed()方法将不会进行任何操作。</p>
</blockquote>
<h2 id="BeatReactor"><a href="#BeatReactor" class="headerlink" title="BeatReactor"></a>BeatReactor</h2><p>BeatReactor用于<strong>向Nacos服务端发送已注册服务的心跳</strong>。成员变量Map&lt;String, BeatInfo&gt; dom2Beat中保存了需要发送的BeatInfo，key为{serviceName}#{ip}#{port}，value为对应的BeatInfo。BeatReactor会启动名为com.alibaba.nacos.naming.beat.sender的线程来发送心跳，默认线程数为1~CPU核心数的一半，可由namingClientBeatThreadCount参数指定。<br>默认情况下每<strong>5秒</strong>发送一次心跳，可根据Nacos服务端返回的clientBeatInterval的值调整心跳间隔。</p>
<h2 id="HostReactor"><a href="#HostReactor" class="headerlink" title="HostReactor"></a>HostReactor</h2><p>HostReactor<strong>用于获取、保存、更新各Service实例信息。</strong>成员变量Map&lt;String, ServiceInfo&gt; serviceInfoMap中保存了已获取到的服务的信息，key为{服务名}@@{集群名}。HostReactor会启动名为com.alibaba.nacos.client.naming.updater的线程来更新服务信息，默认线程数为1~CPU核心数的一半，可由namingPollingThreadCount参数指定。定时任务UpdateTask会根据服务的cacheMillis值定时更新服务信息，默认值为<strong>10秒</strong>。该定时任务会在获取某一服务信息时创建，保存在成员变量Map&lt;String, ScheduledFuture&lt;?&gt;&gt; futureMap中。</p>
<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><h3 id="PushReceiver"><a href="#PushReceiver" class="headerlink" title="PushReceiver"></a>PushReceiver</h3><p>PushReceiver<strong>用于接收Nacos服务端的推送</strong>，初始化时会创建DatagramSocket使用UDP的方式接收推送。会启动<strong>1</strong>个名为com.alibaba.nacos.naming.push.receiver的线程。</p>
<h3 id="FailoverReactor"><a href="#FailoverReactor" class="headerlink" title="FailoverReactor"></a>FailoverReactor</h3><p>用于故障转移，会启动<strong>1</strong>个名为com.alibaba.nacos.naming.failover的线程并定时读取名为00-00—000-VIPSRV_FAILOVER_SWITCH-000—00-00的文件，内容为1时表示开启，此时获取服务信息时会返回FailoverReactor缓存的服务信息。</p>
<h3 id="Balancer"><a href="#Balancer" class="headerlink" title="Balancer"></a>Balancer</h3><p>根据服务实例的权重挑选一个实例，实现简单的负载均衡。</p>
<h3 id="DiskCache"><a href="#DiskCache" class="headerlink" title="DiskCache"></a>DiskCache</h3><p>用于服务信息的持久化。</p>
<h2 id="Naming-API"><a href="#Naming-API" class="headerlink" title="Naming API"></a>Naming API</h2><p>API汇总如下：</p>
<table>
<thead>
<tr>
<th>Method</th>
<th>URI</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>POST</td>
<td>/nacos/v1/ns/instance</td>
<td>注册实例</td>
</tr>
<tr>
<td>DELETE</td>
<td>/nacos/v1/ns/instance</td>
<td>注销实例</td>
</tr>
<tr>
<td>GET</td>
<td>/nacos/v1/ns/instance/list</td>
<td>获取实例列表</td>
</tr>
<tr>
<td>PUT</td>
<td>/nacos/v1/ns/instance/beat</td>
<td>发送心跳</td>
</tr>
<tr>
<td>GET</td>
<td>/nacos/v1/ns/api/hello</td>
<td>Nacos服务端状态</td>
</tr>
<tr>
<td>GET</td>
<td>/nacos/v1/ns/service/list</td>
<td>获取所有服务名</td>
</tr>
</tbody></table>
<h2 id="参数列表及示例"><a href="#参数列表及示例" class="headerlink" title="参数列表及示例"></a>参数列表及示例</h2><h3 id="注册实例"><a href="#注册实例" class="headerlink" title="注册实例"></a>注册实例</h3><table>
<thead>
<tr>
<th>key</th>
<th>含义</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>namespaceId</td>
<td>命名空间</td>
<td>默认为public</td>
</tr>
<tr>
<td>ip</td>
<td>实例IP地址</td>
<td></td>
</tr>
<tr>
<td>port</td>
<td>实例端口</td>
<td></td>
</tr>
<tr>
<td>weight</td>
<td>权重</td>
<td>默认为1.0</td>
</tr>
<tr>
<td>enable</td>
<td>是否开启</td>
<td>默认为true</td>
</tr>
<tr>
<td>healthy</td>
<td>健康状态</td>
<td>默认为true</td>
</tr>
<tr>
<td>metadata</td>
<td>其他信息</td>
<td></td>
</tr>
<tr>
<td>serviceName</td>
<td>服务名</td>
<td></td>
</tr>
<tr>
<td>clusterName</td>
<td>集群名</td>
<td>默认为DEFAULT</td>
</tr>
</tbody></table>
<p>请求示例：<a target="_blank" rel="noopener" href="http://localhost:8848/nacos/v1/ns/instance?metadata=%7B%7D&namespaceId=public&port=8888&enable=true&healthy=true&ip=11.11.11.11&clusterName=TEST1&weight=1.0&serviceName=nacos.test.3&encoding=UTF-8&">http://localhost:8848/nacos/v1/ns/instance?metadata=%7B%7D&amp;namespaceId=public&amp;port=8888&amp;enable=true&amp;healthy=true&amp;ip=11.11.11.11&amp;clusterName=TEST1&amp;weight=1.0&amp;serviceName=nacos.test.3&amp;encoding=UTF-8&amp;</a></p>
<p>返回示例：ok</p>
<h3 id="注销实例"><a href="#注销实例" class="headerlink" title="注销实例"></a>注销实例</h3><table>
<thead>
<tr>
<th>key</th>
<th>含义</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>namespaceId</td>
<td>命名空间</td>
<td>默认为public</td>
</tr>
<tr>
<td>ip</td>
<td>实例IP地址</td>
<td></td>
</tr>
<tr>
<td>port</td>
<td>实例端口</td>
<td></td>
</tr>
<tr>
<td>serviceName</td>
<td>服务名</td>
<td></td>
</tr>
<tr>
<td>clusterName</td>
<td>集群名</td>
<td>默认为DEFAULT</td>
</tr>
</tbody></table>
<p>请求示例：<a target="_blank" rel="noopener" href="http://localhost:8848/nacos/v1/ns/instance?cluster=DEFAULT&amp;serviceName=nacos.test.3&amp;encoding=UTF-8&amp;namespaceId=public&amp;port=9999&amp;ip=2.2.2.2&amp;">http://localhost:8848/nacos/v1/ns/instance?cluster=DEFAULT&amp;serviceName=nacos.test.3&amp;encoding=UTF-8&amp;namespaceId=public&amp;port=9999&amp;ip=2.2.2.2&amp;</a></p>
<p>返回示例：ok</p>
<h3 id="获取实例列表"><a href="#获取实例列表" class="headerlink" title="获取实例列表"></a>获取实例列表</h3><table>
<thead>
<tr>
<th>key</th>
<th>含义</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>namespaceId</td>
<td>命名空间</td>
<td>默认为public</td>
</tr>
<tr>
<td>serviceName</td>
<td>服务名</td>
<td></td>
</tr>
<tr>
<td>clusters</td>
<td>集群名</td>
<td>默认为DEFAULT</td>
</tr>
<tr>
<td>udpPort</td>
<td>监听的UPD端口号</td>
<td>由PushReceiver创建</td>
</tr>
<tr>
<td>clientIP</td>
<td>客户端IP</td>
<td></td>
</tr>
<tr>
<td>healthyOnly</td>
<td>是否只返回健康的实例</td>
<td></td>
</tr>
</tbody></table>
<p>请求示例：<a target="_blank" rel="noopener" href="http://localhost:8848/nacos/v1/ns/instance/list?healthyOnly=false&amp;namespaceId=public&amp;clientIP=172.16.20.114&amp;serviceName=nacos.test.3&amp;udpPort=53957&amp;encoding=UTF-8&amp;">http://localhost:8848/nacos/v1/ns/instance/list?healthyOnly=false&amp;namespaceId=public&amp;clientIP=172.16.20.114&amp;serviceName=nacos.test.3&amp;udpPort=53957&amp;encoding=UTF-8&amp;</a></p>
<p>返回示例：{“metadata”:{},”dom”:”nacos.test.3”,”cacheMillis”:10000,”useSpecifiedURL”:false,”hosts”:[{“valid”:true,”marked”:false,”metadata”:{},”instanceId”:”2.2.2.2#9999#DEFAULT#nacos.test.3”,”port”:9999,”ip”:”2.2.2.2”,”clusterName”:”DEFAULT”,”weight”:1.0,”serviceName”:”nacos.test.3”,”enabled”:true},{“valid”:true,”marked”:false,”metadata”:{},”instanceId”:”11.11.11.11#8888#TEST1#nacos.test.3”,”port”:8888,”ip”:”11.11.11.11”,”clusterName”:”TEST1”,”weight”:1.0,”serviceName”:”nacos.test.3”,”enabled”:true}],”checksum”:”bd1054e6afb8d10730d945d74c4ce4421550584589236”,”lastRefTime”:1550584589236,”env”:””,”clusters”:””}</p>
<h3 id="发送心跳"><a href="#发送心跳" class="headerlink" title="发送心跳"></a>发送心跳</h3><table>
<thead>
<tr>
<th>key</th>
<th>含义</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>namespaceId</td>
<td>命名空间</td>
<td>默认为public</td>
</tr>
<tr>
<td>serviceName</td>
<td>服务名</td>
<td></td>
</tr>
<tr>
<td>beat</td>
<td>BeatInfo的JSON字符串</td>
<td></td>
</tr>
</tbody></table>
<p>BeatInfo对象结构如下，与Instance对象类似：</p>
<table>
<thead>
<tr>
<th>field</th>
<th>含义</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>port</td>
<td>端口</td>
<td></td>
</tr>
<tr>
<td>ip</td>
<td>IP地址</td>
<td></td>
</tr>
<tr>
<td>weight</td>
<td>权重</td>
<td></td>
</tr>
<tr>
<td>metadata</td>
<td>其他信息</td>
<td></td>
</tr>
<tr>
<td>serviceName</td>
<td>服务名</td>
<td></td>
</tr>
<tr>
<td>clusterName</td>
<td>集群名</td>
<td></td>
</tr>
<tr>
<td>scheduled</td>
<td>是否心跳中</td>
<td>这个是BeatReactor用来标识状态的</td>
</tr>
</tbody></table>
<p>请求示例：<a target="_blank" rel="noopener" href="http://localhost:8848/nacos/v1/ns/instance/beat?beat=%7B%22cluster%22:%22DEFAULT%22,%22ip%22:%222.2.2.2%22,%22metadata%22:%7B%7D,%22port%22:9999,%22scheduled%22:true,%22serviceName%22:%22nacos.test.3%22,%22weight%22:1.0%7D&serviceName=nacos.test.3&encoding=UTF-8&namespaceId=public&">http://localhost:8848/nacos/v1/ns/instance/beat?beat=%7B%22cluster%22%3A%22DEFAULT%22%2C%22ip%22%3A%222.2.2.2%22%2C%22metadata%22%3A%7B%7D%2C%22port%22%3A9999%2C%22scheduled%22%3Atrue%2C%22serviceName%22%3A%22nacos.test.3%22%2C%22weight%22%3A1.0%7D&amp;serviceName=nacos.test.3&amp;encoding=UTF-8&amp;namespaceId=public&amp;</a></p>
<p>返回示例：{“clientBeatInterval”:5000}</p>
<h3 id="Nacos服务端状态"><a href="#Nacos服务端状态" class="headerlink" title="Nacos服务端状态"></a>Nacos服务端状态</h3><table>
<thead>
<tr>
<th>key</th>
<th>含义</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>namespaceId</td>
<td>命名空间</td>
<td>默认为public</td>
</tr>
</tbody></table>
<p>请求示例：<a target="_blank" rel="noopener" href="http://localhost:8848/nacos/v1/ns/api/hello?encoding=UTF-8&amp;namespaceId=public&amp;">http://localhost:8848/nacos/v1/ns/api/hello?encoding=UTF-8&amp;namespaceId=public&amp;</a></p>
<p>返回示例：{“msg”:”Hello! I am Nacos-Naming and healthy! total services: raft 2, local port:8848”}</p>
<h3 id="获取所有服务名"><a href="#获取所有服务名" class="headerlink" title="获取所有服务名"></a>获取所有服务名</h3><table>
<thead>
<tr>
<th>key</th>
<th>含义</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>namespaceId</td>
<td>命名空间</td>
<td>默认为public</td>
</tr>
<tr>
<td>pageNo</td>
<td>页码</td>
<td>注意从1开始</td>
</tr>
<tr>
<td>pageSize</td>
<td>返回数量</td>
<td></td>
</tr>
<tr>
<td>selector</td>
<td>过滤器</td>
<td></td>
</tr>
</tbody></table>
<p>请求示例：<a target="_blank" rel="noopener" href="http://localhost:8848/nacos/v1/ns/service/list?pageSize=100&amp;encoding=UTF-8&amp;namespaceId=public&amp;pageNo=0&amp;">http://localhost:8848/nacos/v1/ns/service/list?pageSize=100&amp;encoding=UTF-8&amp;namespaceId=public&amp;pageNo=0&amp;</a></p>
<p>返回示例：{“count”:1,”doms”:[“nacos.test.3”]}</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/12/21/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B9%8Bnacos%E4%B9%8B%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="灰(｢･ω･)｢嘿灰">
      <meta itemprop="description" content="学习还是需要记录">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="个人博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/12/21/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B9%8Bnacos%E4%B9%8B%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/" class="post-title-link" itemprop="url">nacos之配置中心原理解析</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2020-12-21 15:56:40" itemprop="dateCreated datePublished" datetime="2020-12-21T15:56:40+08:00">2020-12-21</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2024-07-12 10:34:27" itemprop="dateModified" datetime="2024-07-12T10:34:27+08:00">2024-07-12</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" itemprop="url" rel="index"><span itemprop="name">微服务</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>作者：逅弈<br>链接：<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/38b5452c9fec">https://www.jianshu.com/p/38b5452c9fec</a></p>
<h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p>使用长轮询机制：长轮询是在轮询基础上做的，也是不断的访问服务器，但是服务器不会即刻返回，而是等有新消息到来时再返回，或者等到超时时间到了再返回。</p>
<ol>
<li>Server端采用队列，为每一个请求创建一个专属队列</li>
<li>Server端有新消息进来，放入每一个请求的队列中进行返回，或者等待超时时间结束捕获异常后再返回</li>
</ol>
<p><strong>聊天室长轮询实例</strong>：</p>
<p>为每一个进入聊天室的用户（与<code>Server</code>端建立连接的用户）创建一个队列，每个用户轮询时都去询问自己的队列，如果没有新消息就等待，如果后端一旦接收到新消息就将消息放入对应的等待队列中返回本次请求；或者超时也返回请求    </p>
<h2 id="推还是拉"><a href="#推还是拉" class="headerlink" title="推还是拉"></a>推还是拉</h2><p>客户端和服务端之间的数据交互，无外乎两种情况：</p>
<ul>
<li>服务端推数据给客户端</li>
<li>客户端从服务端拉数据</li>
</ul>
<p>那到底是推还是拉呢，从 Nacos 客户端通过 Listener 来接收最新数据的这个做法来看，感觉像是服务端推的数据，但是不能想当然，要想知道答案，最快最准确的方法就是从源码中去寻找。</p>
<h3 id="创建-ConfigService"><a href="#创建-ConfigService" class="headerlink" title="创建 ConfigService"></a>创建 ConfigService</h3><p>从我们的 demo 中可以知道，首先是创建了一个 ConfigService。而 ConfigService 是通过 ConfigFactory 类创建的，如下图所示：</p>
<p><img src="https://upload-images.jianshu.io/upload_images/5417792-ba05ced35148cde1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1200/format/webp" alt="img"></p>
<p>可以看到实际是通过反射调用了 NacosConfigService 的构造方法来创建 ConfigService 的，而且是有一个 Properties 参数的构造方法。</p>
<p>需要注意的是，这里并没有通过单例或者缓存技术，也就是说每次调用都会重新创建一个 ConfigService的实例。</p>
<h3 id="实例化-ConfigService"><a href="#实例化-ConfigService" class="headerlink" title="实例化 ConfigService"></a>实例化 ConfigService</h3><p>现在我们来看下 NacosConfigService 的构造方法，看看 ConfigService 是怎么实例化的，如下图所示：</p>
<p><img src="https://upload-images.jianshu.io/upload_images/5417792-f6c665c4e2de941f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1200/format/webp" alt="img"></p>
<p>实例化时主要是初始化了两个对象，他们分别是：</p>
<ul>
<li>HttpAgent</li>
<li>ClientWorker</li>
</ul>
<h4 id="HttpAgent"><a href="#HttpAgent" class="headerlink" title="HttpAgent"></a>HttpAgent</h4><p>其中 agent 是通过装饰着模式实现的，ServerHttpAgent 是实际工作的类，MetricsHttpAgent 在内部也是调用了 ServerHttpAgent 的方法，另外加上了一些统计操作，所以我们只需要关心 ServerHttpAgent 的功能就可以了。</p>
<p>agent 实际是在 ClientWorker 中发挥能力的，下面我们来看下 ClientWorker 类。</p>
<h4 id="ClientWorker"><a href="#ClientWorker" class="headerlink" title="ClientWorker"></a>ClientWorker</h4><p>以下是 ClientWorker 的构造方法，如下图所示：</p>
<p><img src="https://upload-images.jianshu.io/upload_images/5417792-5104c6d72e2aaa8d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1200/format/webp" alt="img"></p>
<p>可以看到 ClientWorker 除了将 HttpAgent 维持在自己内部，还创建了两个线程池：</p>
<p>第一个线程池是只拥有一个线程用来执行定时任务的 executor，executor 每隔 10ms 就会执行一次 checkConfigInfo() 方法，从方法名上可以知道是每 10 ms 检查一次配置信息。</p>
<p>第二个线程池是一个普通的线程池，从 ThreadFactory 的名称可以看到这个线程池是做长轮询的。</p>
<p>现在让我们来看下 executor 每 10ms 执行的方法到底是干什么的，如下图所示：</p>
<p><img src="https://upload-images.jianshu.io/upload_images/5417792-9e84ab368c709db7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1200/format/webp" alt="img"></p>
<p>可以看到，checkConfigInfo 方法是取出了一批任务，然后提交给 executorService 线程池去执行，执行的任务就是 LongPollingRunnable，每个任务都有一个 taskId。</p>
<p>现在我们来看看 LongPollingRunnable 做了什么，主要分为两部分，第一部分是检查本地的配置信息，第二部分是获取服务端的配置信息然后更新到本地。</p>
<p><strong>1.本地检查</strong></p>
<p>首先取出与该 taskId 相关的 CacheData，然后对 CacheData 进行检查，包括本地配置检查和监听器的 md5 检查，本地检查主要是做一个故障容错，当服务端挂掉后，Nacos 客户端可以从本地的文件系统中获取相关的配置信息，如下图所示：</p>
<p><img src="/2020/12/21/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B9%8Bnacos%E4%B9%8B%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/5417792-d973ee3fed6496df.png" alt="img"></p>
<p>通过跟踪 checkLocalConfig 方法，可以看到 Nacos 将配置信息保存在了</p>
<p>~/nacos/config/fixed-{address}_8848_nacos/snapshot/DEFAULT_GROUP/{dataId}</p>
<p>这个文件中，我们看下这个文件中保存的内容，如下图所示：</p>
<p><img src="https://upload-images.jianshu.io/upload_images/5417792-ba0df548e35c29fb.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1200/format/webp" alt="img"></p>
<p><strong>2.服务端检查</strong></p>
<p>然后通过 checkUpdateDataIds() 方法从服务端获取那些值发生了变化的 dataId 列表，</p>
<p>通过 getServerConfig 方法，根据 dataId 到服务端获取最新的配置信息，接着将最新的配置信息保存到 CacheData 中。</p>
<p>最后调用 CacheData 的 checkListenerMd5 方法，可以看到该方法在第一部分也被调用过，我们需要重点关注一下。</p>
<p><img src="/2020/12/21/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B9%8Bnacos%E4%B9%8B%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/5417792-4de0d8c1acc24260.png" alt="img"></p>
<p>可以看到，在该任务的最后，也就是在 finally 中又重新通过 executorService 提交了本任务。</p>
<h3 id="添加-Listener"><a href="#添加-Listener" class="headerlink" title="添加 Listener"></a>添加 Listener</h3><p><font color="red">NacosContextRefresher</font>接收到ApplicationReadyEvent事件时为每个配置文件增加监听器，添加的监听器是AbstractSharedListener的匿名类。匿名内部类中发布<font color="red">RefreshEvent</font>事件，此为动态刷新配置中心配置的关键。即使用 ConfigService 来添加一个 Listener 了，最终是调用了 ClientWorker 的 addTenantListeners 方法，如下图所示：</p>
<p><img src="/2020/12/21/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B9%8Bnacos%E4%B9%8B%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/5417792-35b632cd90154086.png" alt="img"></p>
<p>该方法分为两个部分，首先根据 dataId，group 和当前的场景获取一个 CacheData 对象，然后将当前要添加的 listener 对象添加到 CacheData 中去。</p>
<p>也就是说 listener 最终是被这里的 CacheData 所持有了，那 listener 的回调方法 receiveConfigInfo 就应该是在 CacheData 中触发的。</p>
<p>我们发现 CacheData 是出现频率非常高的一个类，在 LongPollingRunnable 的任务中，几乎所有的方法都围绕着 CacheData 类，现在添加 Listener 的时候，实际上该 Listener 也被委托给了 CacheData，那我们要重点关注下 CacheData 类了。</p>
<h3 id="CacheData"><a href="#CacheData" class="headerlink" title="CacheData"></a>CacheData</h3><p>首先让我们来看一下 CacheData 中的成员变量，如下图所示：</p>
<p><img src="/2020/12/21/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B9%8Bnacos%E4%B9%8B%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/5417792-d3e711176c9987b9.png" alt="img"></p>
<p>可以看到除了 dataId，group，content，taskId 这些跟配置相关的属性，还有两个比较重要的属性：listeners、md5。</p>
<p>listeners 是该 CacheData 所关联的所有 listener，不过不是保存的原始的 Listener 对象，而是包装后的 ManagerListenerWrap 对象，该对象除了持有 Listener 对象，还持有了一个 lastCallMd5 属性。</p>
<p>另外一个属性 md5 就是根据当前对象的 content 计算出来的 md5 值。</p>
<h3 id="触发回调"><a href="#触发回调" class="headerlink" title="触发回调"></a>触发回调</h3><p>现在我们对 ConfigService 有了大致的了解了，现在剩下最后一个重要的问题还没有答案，那就是 ConfigService 的 Listener 是在什么时候触发回调方法 receiveConfigInfo 的。</p>
<p>现在让我们回过头来想一下，在 ClientWorker 中的定时任务中，启动了一个长轮询的任务：LongPollingRunnable，该任务多次执行了 cacheData.checkListenerMd5() 方法，那现在就让我们来看下这个方法到底做了些什么，如下图所示：</p>
<p><img src="/2020/12/21/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B9%8Bnacos%E4%B9%8B%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/5417792-252a0c5c6da61070.png" alt="img"></p>
<p>到这里应该就比较清晰了，该方法会检查 CacheData 当前的 md5 与 CacheData 持有的所有 Listener 中保存的 md5 的值是否一致，如果不一致，就执行一个安全的监听器的通知方法：safeNotifyListener，通知什么呢？我们可以大胆的猜一下，应该是通知 Listener 的使用者，该 Listener 所关注的配置信息已经发生改变了。现在让我们来看一下 safeNotifyListener 方法，如下图所示：</p>
<p><img src="https://upload-images.jianshu.io/upload_images/5417792-991eeb4ef41b05fc.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1200/format/webp" alt="img"></p>
<p>可以看到在 safeNotifyListener 方法中，重点关注下红框中的三行代码：获取最新的配置信息，调用 Listener 的回调方法，将最新的配置信息作为参数传入，这样 Listener 的使用者就能接收到变更后的配置信息了，最后更新 ListenerWrap 的 md5 值。和我们猜测的一样， Listener 的回调方法就是在该方法中触发的。</p>
<h3 id="Md5何时变更"><a href="#Md5何时变更" class="headerlink" title="Md5何时变更"></a>Md5何时变更</h3><p>那 CacheData 的 md5 值是何时发生改变的呢？我们可以回想一下，在上面的 LongPollingRunnable 所执行的任务中，在获取服务端发生变更的配置信息时，将最新的 content 数据写入了 CacheData 中，我们可以看下该方法如下：</p>
<p><img src="https://upload-images.jianshu.io/upload_images/5417792-1a99dccdefa936cd.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/826/format/webp" alt="img"></p>
<p>可以看到是在长轮询的任务中，当服务端配置信息发生变更时，客户端将最新的数据获取下来之后，保存在了 CacheData 中，同时更新了该 CacheData 的 md5 值，所以当下次执行 checkListenerMd5 方法时，就会发现当前 listener 所持有的 md5 值已经和 CacheData 的 md5 值不一样了，也就意味着服务端的配置信息发生改变了，这时就需要将最新的数据通知给 Listener 的持有者。</p>
<p>至此配置中心的完整流程已经分析完毕了，可以发现，Nacos 并不是通过推的方式将服务端最新的配置信息发送给客户端的，而是客户端维护了一个长轮询的任务，定时去拉取发生变更的配置信息，然后将最新的数据推送给 Listener 的持有者。</p>
<h3 id="拉的优势"><a href="#拉的优势" class="headerlink" title="拉的优势"></a>拉的优势</h3><p>客户端拉取服务端的数据与服务端推送数据给客户端相比，优势在哪呢，为什么 Nacos 不设计成主动推送数据，而是要客户端去拉取呢？如果用推的方式，服务端需要维持与客户端的长连接，这样的话需要耗费大量的资源，并且还需要考虑连接的有效性，例如需要通过心跳来维持两者之间的连接。而用拉的方式，客户端只需要通过一个无状态的 http 请求即可获取到服务端的数据。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>Nacos 服务端创建了相关的配置项后，客户端就可以进行监听了。</p>
<p>客户端是通过一个定时任务来检查自己监听的配置项的数据的，一旦服务端的数据发生变化时，客户端将会获取到最新的数据，并将最新的数据保存在一个 CacheData 对象中，然后会重新计算 CacheData 的 md5 属性的值，此时就会对该 CacheData 所绑定的 Listener 触发 receiveConfigInfo 回调。</p>
<p>考虑到服务端故障的问题，客户端将最新数据获取后会保存在本地的 snapshot 文件中，以后会优先从文件中获取配置信息的值。</p>
<p>长轮询请求设置的超时时间为30s。服务端拿到客户端提交的超时时间后，又减去了 500ms 也就是说服务端在这里使用了一个比客户端提交的时间少 500ms 的超时时间，也就是 29.5s。</p>
<p>ClientLongPolling 被提交给 scheduler 执行之后，实际执行的内容可以拆分成以下四个步骤：</p>
<ul>
<li>1.创建一个调度的任务，调度的延时时间为 29.5s</li>
<li>2.将该 ClientLongPolling 自身的实例添加到一个 allSubs 中去</li>
<li>3.延时时间到了之后，首先将该 ClientLongPolling 自身的实例从 allSubs 中移除</li>
<li>4.获取服务端中保存的对应客户端请求的 groupKeys 是否发生变更，将结果写入 response 返回给客户端</li>
</ul>
<p><img src="/2020/12/21/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B9%8Bnacos%E4%B9%8B%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/image-20210113114155184.png" alt="image-20210113114155184"></p>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/acb9b1093a54">Nacos 配置实时更新原理分析</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/12/21/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B9%8Bnacos%E4%B9%8B%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="灰(｢･ω･)｢嘿灰">
      <meta itemprop="description" content="学习还是需要记录">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="个人博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/12/21/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B9%8Bnacos%E4%B9%8B%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/" class="post-title-link" itemprop="url">nacos之简单使用</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2020-12-21 15:12:37" itemprop="dateCreated datePublished" datetime="2020-12-21T15:12:37+08:00">2020-12-21</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2024-07-12 10:34:27" itemprop="dateModified" datetime="2024-07-12T10:34:27+08:00">2024-07-12</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" itemprop="url" rel="index"><span itemprop="name">微服务</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="nacos作用"><a href="#nacos作用" class="headerlink" title="nacos作用"></a>nacos作用</h2><ul>
<li>配置中心</li>
<li>注册中心</li>
</ul>
<h2 id="nacos组成"><a href="#nacos组成" class="headerlink" title="nacos组成"></a>nacos组成</h2><ul>
<li>服务端（记录配置信息及注册服务）</li>
<li>客户端（通过客户端获取配置和注册的服务信息）</li>
</ul>
<h2 id="简单使用"><a href="#简单使用" class="headerlink" title="简单使用"></a>简单使用</h2><h3 id="客户端使用"><a href="#客户端使用" class="headerlink" title="客户端使用"></a>客户端使用</h3><p><img src="/2020/12/21/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B9%8Bnacos%E4%B9%8B%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/5417792-3f740507702e5345.png" alt="img"></p>
<p>执行后将打印如下信息：<br><img src="/2020/12/21/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B9%8Bnacos%E4%B9%8B%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/5417792-bbb7c19dd26d12e7.png" alt="img"></p>
<h3 id="修改配置信息"><a href="#修改配置信息" class="headerlink" title="修改配置信息"></a>修改配置信息</h3><img src="/2020/12/21/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B9%8Bnacos%E4%B9%8B%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/5417792-817fcfe4227320fa.png" alt="img" style="zoom: 33%;">

<p>修改完配置，点击 “发布” 按钮后，客户端将会收到最新的数据，如下图所示：<br><img src="/2020/12/21/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B9%8Bnacos%E4%B9%8B%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/5417792-f64c8649f23cde67.png" alt="img" style="zoom:50%;"></p>
<h2 id="spring-cloud"><a href="#spring-cloud" class="headerlink" title="spring-cloud"></a>spring-cloud</h2><h3 id="pom配置"><a href="#pom配置" class="headerlink" title="pom配置"></a>pom配置</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-alibaba-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.1.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">	<span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">      	<span class="attr">server-addr:</span> <span class="number">10.16</span><span class="number">.35</span><span class="number">.74</span><span class="string">:8848,10.16.32.168:8848,10.16.35.243:8848</span></span><br><span class="line">        <span class="attr">username:</span> <span class="string">quixmart2</span></span><br><span class="line">        <span class="attr">password:</span> <span class="string">dbf20920b03e6ee725a681a47e4eecec</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">&#x27;yml&#x27;</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">&#x27;646e3782-3a6f-46db-9b8c-6cae7f620be1&#x27;</span></span><br><span class="line">        <span class="comment"># 读取公共中间件配置</span></span><br><span class="line">        <span class="string">ext-config[0]:</span></span><br><span class="line">          <span class="attr">data-id:</span> <span class="string">mysql.yml</span></span><br><span class="line">          <span class="attr">group:</span> <span class="string">PUBLIC</span></span><br><span class="line">        <span class="string">ext-config[1]:</span></span><br><span class="line">          <span class="attr">data-id:</span> <span class="string">redis.yml</span></span><br><span class="line">          <span class="attr">group:</span> <span class="string">PUBLIC</span></span><br><span class="line">        <span class="string">ext-config[2]:</span></span><br><span class="line">          <span class="attr">data-id:</span> <span class="string">rabbitmq.yml</span></span><br><span class="line">          <span class="attr">group:</span> <span class="string">PUBLIC</span></span><br><span class="line">        <span class="string">ext-config[3]:</span></span><br><span class="line">          <span class="attr">data-id:</span> <span class="string">mongodb.yml</span></span><br><span class="line">          <span class="attr">group:</span> <span class="string">PUBLIC</span></span><br><span class="line">        <span class="string">ext-config[4]:</span></span><br><span class="line">          <span class="attr">data-id:</span> <span class="string">elasticjob.yml</span></span><br><span class="line">          <span class="attr">group:</span> <span class="string">PUBLIC</span></span><br><span class="line">        <span class="string">ext-config[5]:</span></span><br><span class="line">          <span class="attr">data-id:</span> <span class="string">mqtt.yml</span></span><br><span class="line">          <span class="attr">group:</span> <span class="string">PUBLIC</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="number">10.16</span><span class="number">.35</span><span class="number">.74</span><span class="string">:8848,10.16.32.168:8848,10.16.35.243:8848</span></span><br><span class="line">        <span class="attr">username:</span> <span class="string">quixmart2</span></span><br><span class="line">        <span class="attr">password:</span> <span class="string">dbf20920b03e6ee725a681a47e4eecec</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">&#x27;646e3782-3a6f-46db-9b8c-6cae7f620be1&#x27;</span></span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/12/18/java%E4%B9%8B%E5%AD%97%E8%8A%82%E5%8F%8A%E5%AD%97%E7%AC%A6%E7%AD%89%E8%AF%A6%E8%A7%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="灰(｢･ω･)｢嘿灰">
      <meta itemprop="description" content="学习还是需要记录">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="个人博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/12/18/java%E4%B9%8B%E5%AD%97%E8%8A%82%E5%8F%8A%E5%AD%97%E7%AC%A6%E7%AD%89%E8%AF%A6%E8%A7%A3/" class="post-title-link" itemprop="url">java之字节及字符等详解</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2020-12-18 16:59:27" itemprop="dateCreated datePublished" datetime="2020-12-18T16:59:27+08:00">2020-12-18</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2024-07-12 10:34:26" itemprop="dateModified" datetime="2024-07-12T10:34:26+08:00">2024-07-12</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/java%E5%9F%BA%E7%A1%80/" itemprop="url" rel="index"><span itemprop="name">java基础</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><strong>1.bit:位 （小写b) 也称比特</strong></p>
<p>是英文 binary digit的缩写 二进制数系统中，每个0或1就是一个位(bit)<br>位是数据存储（计算机中信息）的最小单位<br>计算机中的CPU位数指的是CPU一次能处理的最大位数。例如32位计算机的CPU一次最多能处理32位数据</p>
<p><strong>2.Byte:字节(大写B)</strong></p>
<p>8bit就称为一个字节（Byte）, 1Byte=8bit<br>记为Byte或B,是计算机中信息的基本单位</p>
<p><strong>3.区别</strong><br><img src="/2020/12/18/java%E4%B9%8B%E5%AD%97%E8%8A%82%E5%8F%8A%E5%AD%97%E7%AC%A6%E7%AD%89%E8%AF%A6%E8%A7%A3/180125-20191106131450465-1166740117.png" alt="img"></p>
<p> <strong>实例</strong></p>
<p>bps 是 bits per second 的简称。一般数据机及网络通讯的传输速率都是以「bps」比特/位为单位。如 56Kbps、100.0Mbps 等。<br>Bps 是 Byte per second 的简称。而电脑一般都以「Bps」字节/速度为单位，如 1Mb/s(Mbps) 大约等同 128 KB/s(KBps)。<br>举例：USB 2.0 接口传输速率为 “480Mbps”，很多人误解为 480 兆/秒，实际 “480Mbps” 是指 “480 兆比特/秒” 或 “480 兆位/秒”，等于 “60 兆字节/秒”。</p>
<p><strong>4.相关换算</strong><br>1个字母=1个字节=8bit(8位)</p>
<p>1个数字=1个字节=8bit(8位)</p>
<p>1个汉字=2个字节=16bit(16位)</p>
<p>1 Byte = 8 Bits</p>
<p>1 KB = 1024 Bytes</p>
<p>1 MB = 1024 KB</p>
<p>1 GB = 1024 MB</p>
<p><strong>char与byte的区别</strong></p>
<p> <strong><em>\</em>byte 是字节数据类型 ，是有符号型的，占1 个字节；大小范围为-128—127 。char 是字符数据类型 ，是无符号型的，占2字节(Unicode\</strong>*<em>码*</em> *<em>）；大小*</em>*<em>范围*</em> *<em>是*</em>*<em>0*</em>*<em>—*</em>*<em>65535*</em> *<em>；*</em>*<em>char是一个16位二进制的Unicode字符，JAVA用char来表示一个字符*</em> *<em>。***</em></p>
<p>通过代码示例来比较二者区别：</p>
<p>1、Char是无符号型的，可以表示一个整数，不能表示负数；而byte是有符号型的，可以表示-128—127 的数；如</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> c = (<span class="keyword">char</span>) -<span class="number">90</span>; <span class="comment">// char不能识别负数，必须强制转换否则报错，即使强制转换之后，也无法识别 </span></span><br><span class="line">System.out.println(c); </span><br><span class="line"><span class="keyword">byte</span> d1 = <span class="number">1</span>; </span><br><span class="line"><span class="keyword">byte</span> d2 = -<span class="number">1</span>; </span><br><span class="line"><span class="keyword">byte</span> d3 = <span class="number">127</span>; <span class="comment">// 如果是byte d3 = 128;会报错 </span></span><br><span class="line"><span class="keyword">byte</span> d4 = -<span class="number">128</span>; <span class="comment">// 如果是byte d4 = -129;会报错 </span></span><br><span class="line">System.out.println(d1); </span><br><span class="line">System.out.println(d2); </span><br><span class="line">System.out.println(d3); </span><br><span class="line">System.out.println(d4); </span><br></pre></td></tr></table></figure>

<img src="/2020/12/18/java%E4%B9%8B%E5%AD%97%E8%8A%82%E5%8F%8A%E5%AD%97%E7%AC%A6%E7%AD%89%E8%AF%A6%E8%A7%A3/20180622151733747" alt="img" style="zoom:80%;">

<p>2、char可以表中文字符，byte不可以，如：<br>​    char e1 = ‘我’, e2 = ‘你’;<br>​    byte f= (byte) ‘他’; //必须强制转换否则报错<br>​    System.out.println(e1);<br>​    System.out.println(e2);<br>​    System.out.println(f);<br><img src="/2020/12/18/java%E4%B9%8B%E5%AD%97%E8%8A%82%E5%8F%8A%E5%AD%97%E7%AC%A6%E7%AD%89%E8%AF%A6%E8%A7%A3/20180622152135220" alt="img"></p>
<p>3、char、byte、int对于英文字符，可以相互转化，如：<br>​    byte g = ‘a’;  //b对应ASCII是98<br>​    char h = (char) g;<br>​    char i = 85;  //U对应ASCII是85<br>​    int j = ‘h’;  //h对应ASCII是104<br>​    System.out.println(g);<br>​    System.out.println(h);<br>​    System.out.println(i);<br>​    System.out.println(j);<br><img src="/2020/12/18/java%E4%B9%8B%E5%AD%97%E8%8A%82%E5%8F%8A%E5%AD%97%E7%AC%A6%E7%AD%89%E8%AF%A6%E8%A7%A3/20180622152512662" alt="img"></p>
<p><strong>参考</strong></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/tmtony/p/11804575.html">bit(比特)与Byte(字节)的区别与关系</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/m0_37846887/article/details/80774131">char与byte的区别</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>





  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/9/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/9/">9</a><span class="page-number current">10</span><a class="page-number" href="/page/11/">11</a><span class="space">&hellip;</span><a class="page-number" href="/page/16/">16</a><a class="extend next" rel="next" href="/page/11/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



      

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

    </div>
  </main>

  <footer class="footer">
    <div class="footer-inner">
      

      

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">灰(｢･ω･)｢嘿灰</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <script src="//cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  


















  








  

  

</body>
</html>
